<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√≤ ch∆°i Th·ª£ M·ªè Nh√†n R·ªói - 3D</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f172a; /* slate-900 */
            --panel-bg: rgba(30, 41, 59, 0.7); /* slate-800 with transparency */
            --panel-border: #4338ca; /* indigo-700 */
            --accent-color: #f59e0b; /* amber-500 */
            --text-light: #e2e8f0; /* slate-200 */
            --text-dark: #94a3b8; /* slate-400 */
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            user-select: none;
            -webkit-user-select: none;
            overflow: hidden;
        }
        .panel {
            background-color: var(--panel-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--panel-border);
            border-radius: 1rem;
            padding: 1rem;
            box-shadow: 0 0 30px rgba(67, 56, 202, 0.25);
            width: 100%;
            max-width: 340px;
        }
        .toggle-button {
            width: 3.75rem;
            height: 3.75rem;
            background-color: rgba(30, 41, 59, 0.8); /* slate-800 */
            border: 2px solid #334155; /* slate-700 */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .toggle-button:hover {
            transform: scale(1.1);
            border-color: var(--accent-color);
        }
        .toggle-button.active {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            box-shadow: 0 0 15px var(--accent-color);
        }
        .toggle-button svg {
            width: 1.75rem;
            height: 1.75rem;
            color: var(--text-light);
        }
        .btn-primary {
            width: 100%;
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            color: white;
            background-image: linear-gradient(to right, #f59e0b, #f97316);
            border: none;
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(249, 115, 22, 0.4);
        }
        .btn-primary:disabled {
            background-image: none;
            background-color: #475569;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Music Player Styles */
        .slider {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }
        
        .slider::-webkit-slider-track {
            background: #334155;
            height: 8px;
            border-radius: 4px;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            background: #f59e0b;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }
        
        .slider::-moz-range-track {
            background: #334155;
            height: 8px;
            border-radius: 4px;
        }
        
        .slider::-moz-range-thumb {
            background: #f59e0b;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }
        
        .track-item {
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        
        .track-item:hover {
            background-color: rgba(67, 56, 202, 0.2);
            border-color: #4338ca;
        }
        
        .track-item.active {
            background-color: rgba(245, 158, 11, 0.2);
            border-color: #f59e0b;
        }
        
        /* Equipment Popup Styles */
        .equipment-item {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background-color: rgba(67, 56, 202, 0.3);
            border: 1px solid rgba(67, 56, 202, 0.5);
            border-radius: 0.375rem;
            font-size: 0.75rem;
            color: #e2e8f0;
            transition: all 0.2s ease;
        }
        
        .equipment-item:hover {
            background-color: rgba(67, 56, 202, 0.5);
            border-color: #4338ca;
        }
        
        .equipment-item img {
            width: 1rem;
            height: 1rem;
            border-radius: 0.125rem;
            object-fit: cover;
        }
        
        /* Equipment Panel Styles */
        .equipment-panel-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.75rem;
            border: 2px solid transparent;
            border-radius: 0.5rem;
            background-color: rgba(30, 41, 59, 0.5);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .equipment-panel-item:hover {
            background-color: rgba(67, 56, 202, 0.3);
            border-color: #4338ca;
            transform: translateY(-2px);
        }
        
        .equipment-panel-item.equipped {
            background-color: rgba(245, 158, 11, 0.2);
            border-color: #f59e0b;
        }
        
        .equipment-panel-item.equipped::after {
            content: "‚úì";
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background-color: #f59e0b;
            color: white;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .equipment-panel-item img {
            width: 3rem;
            height: 3rem;
            border-radius: 0.375rem;
            object-fit: cover;
            margin-bottom: 0.5rem;
        }
        
        .equipment-panel-item .item-name {
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            color: #e2e8f0;
            margin-bottom: 0.25rem;
        }
        
        .equipment-panel-item .item-rarity {
            font-size: 0.625rem;
            color: #94a3b8;
            text-align: center;
        }
        
        .equipment-panel-item .item-bonus {
            font-size: 0.625rem;
            color: #10b981;
            text-align: center;
            margin-top: 0.25rem;
        }
        .cooldown-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            touch-action: manipulation;
        }
        .upgrade-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-semibold;
            margin-bottom: 0.25rem;
        }
        .upgrade-title svg {
            width: 1.25rem;
            height: 1.25rem;
            color: var(--accent-color);
        }
        .money-flash {
            transition: text-shadow 0.1s;
            text-shadow: 0 0 15px #4ade80, 0 0 5px #4ade80;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem 0.5rem;
            font-size: 1rem;
        }
        .hero-card, .artifact-card {
            background-color: rgba(15, 23, 42, 0.5);
            border-radius: 0.5rem;
            padding: 0.5rem;
            display: flex;
            gap: 0.5rem;
            align-items: center;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }
        .hero-card.equipped, .artifact-card.equipped {
            border-color: var(--accent-color);
        }
        .rarity-Common { color: #94a3b8; }
        .rarity-Rare { color: #3b82f6; }
        .rarity-Epic { color: #a855f7; }
        .rarity-Legend { color: #f59e0b; }
        .rarity-Mythic { color: #ef4444; }
        .rarity-Secret { color: #ec4899; }

        /* Gacha Modal Styles */
        #gacha-modal, #dungeon-combat-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            backdrop-filter: blur(5px);
            pointer-events: none;
        }
        #gacha-modal.show, #dungeon-combat-modal.show {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }
        .gacha-container {
            width: 90%;
            max-width: 800px;
            text-align: center;
        }
        .gacha-reels-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
            position: relative;
        }
        .gacha-reel-wrapper {
            width: 140px;
            height: 140px;
            overflow: hidden;
            border-radius: 1rem;
            background: rgba(0,0,0,0.3);
            border: 2px solid var(--panel-border);
            position: relative;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }
        .gacha-reel-wrapper::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 1rem;
            pointer-events: none;
            box-shadow: 
                inset 0 60px 30px -30px rgba(15, 23, 42, 0.8),
                inset 0 -60px 30px -30px rgba(15, 23, 42, 0.8);
        }
        .gacha-reel {
            display: flex;
            flex-direction: column;
        }
        .gacha-reel img {
            width: 140px;
            height: 140px;
            object-fit: cover;
            flex-shrink: 0;
        }
        .gacha-reel-wrapper.highlight-Common { border-color: #94a3b8; box-shadow: 0 0 20px #94a3b8; }
        .gacha-reel-wrapper.highlight-Rare { border-color: #3b82f6; box-shadow: 0 0 20px #3b82f6; }
        .gacha-reel-wrapper.highlight-Epic { border-color: #a855f7; box-shadow: 0 0 20px #a855f7; }
        .gacha-reel-wrapper.highlight-Legend { border-color: #f59e0b; box-shadow: 0 0 20px #f59e0b; }
        .gacha-reel-wrapper.highlight-Mythic { border-color: #ef4444; box-shadow: 0 0 20px #ef4444; }
        .gacha-reel-wrapper.highlight-Secret { border-color: #ec4899; box-shadow: 0 0 20px #ec4899; }
        
        #gacha-final-result {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s, transform 0.5s;
        }
        #gacha-final-result.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .final-hero-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            background-color: var(--panel-bg);
            padding: 1.5rem;
            border-radius: 1rem;
            border: 1px solid var(--panel-border);
            max-width: 400px;
            margin: 0 auto;
        }
        .final-hero-display .hero-image {
            width: 120px;
            height: 120px;
            border-radius: 0.75rem;
            border: 4px solid var(--accent-color);
        }
        #notification-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            pointer-events: none;
        }
        .notification {
            background-color: rgba(30, 41, 59, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            opacity: 0;
            transform: translateY(-20px);
            animation: notification-fade 3s ease-out forwards;
        }
        .notification.info {
            background-color: rgba(59, 130, 246, 0.9); /* blue-500 */
        }
        .notification.success {
            background-color: rgba(34, 197, 94, 0.9); /* green-500 */
        }
        .notification.error {
            background-color: rgba(239, 68, 68, 0.9); /* red-500 */
        }
        @keyframes notification-fade {
            0% { opacity: 0; transform: translateY(-20px); }
            15% { opacity: 1; transform: translateY(0); }
            85% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
        
        /* Scrollbar styles */
        .custom-scrollbar::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--panel-border);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6366f1; /* indigo-500 */
        }

        /* Banner & Upgrade Tabs */
        .tab-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--panel-border);
        }
        .tab-button {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: 0.5rem 0.5rem 0 0;
            background-color: transparent;
            color: var(--text-dark);
            border: 1px solid transparent;
            border-bottom: none;
            transition: all 0.2s;
        }
        .tab-button.active {
            background-color: var(--panel-bg);
            color: var(--text-light);
            border-color: var(--panel-border);
            border-bottom-color: var(--panel-bg);
            transform: translateY(1px);
        }
        
        .banner-list-item {
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            background-color: rgba(15, 23, 42, 0.5);
            border: 1px solid #334155;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            text-align: left;
        }
        .banner-list-item:hover {
            background-color: var(--panel-border);
        }
        .banner-list-item.active {
            border-color: var(--accent-color);
            background-color: var(--panel-border);
            color: white;
        }
        /* NEW: Info Icon & Tooltip */
        .info-icon {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            background-color: #475569;
            color: var(--text-light);
            cursor: help;
            margin-left: 0.5rem;
        }
        .banner-tooltip {
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            width: max-content;
            max-width: 280px;
            background-color: var(--bg-dark);
            border: 1px solid var(--panel-border);
            border-radius: 0.75rem;
            padding: 0.75rem;
            font-size: 0.8rem;
            text-align: left;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 10;
            pointer-events: none;
        }
        .info-icon:hover .banner-tooltip {
            visibility: visible;
            opacity: 1;
        }
        .banner-tooltip h3 {
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 0.5rem;
            text-align: center;
        }
        .banner-tooltip p {
            margin: 0.25rem 0;
            color: var(--text-light);
        }
        
        /* Dungeon Styles */
        #dungeon-combat-container {
            width: 90%;
            max-width: 600px;
            background-color: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
        }
        .hp-bar {
            width: 100%;
            height: 20px;
            background-color: #475569;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #1e293b;
        }
        .hp-bar-inner {
            height: 100%;
            background-image: linear-gradient(to right, #ef4444, #f87171);
            transition: width 0.2s ease-out;
        }
        #dungeon-enemy-img {
            width: 200px;
            height: 200px;
            object-fit: contain;
            margin: 1rem auto;
            filter: drop-shadow(0 0 15px rgba(0,0,0,0.5));
            animation: enemy-idle 3s ease-in-out infinite;
        }
        @keyframes enemy-idle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        #dungeon-attack-btn {
            padding: 1rem 2rem;
            font-size: 1.5rem;
            margin-top: 1.5rem;
        }
    </style>
</head>
<body>
    <div id="notification-container"></div>
    <div class="relative h-screen w-screen">
        <canvas id="game-canvas"></canvas>

        <div class="absolute top-4 left-4 panel !max-w-xs !py-2 !px-4">
             <div class="resource-item text-xl"><span>üí∞</span> <span id="money" class="font-bold text-green-400 transition-all">0 $</span></div>
        </div>

        <!-- Equipment Popup -->
        <div id="equipment-popup" class="absolute top-4 right-4 z-40 bg-slate-800/95 backdrop-blur-md border border-slate-600 rounded-lg p-3 shadow-lg min-w-[200px] pointer-events-none">
            <div class="text-xs text-slate-400 mb-2 font-semibold">TRANG B·ªä</div>
            
            <!-- Heroes Section -->
            <div class="mb-3">
                <div class="text-xs text-amber-400 mb-1">Anh h√πng:</div>
                <div id="equipped-heroes" class="flex gap-1">
                    <div class="text-xs text-slate-500 italic">Ch∆∞a c√≥</div>
                </div>
            </div>
            
            <!-- Artifacts Section -->
            <div>
                <div class="text-xs text-cyan-400 mb-1">Di v·∫≠t:</div>
                <div id="equipped-artifacts" class="flex gap-1">
                    <div class="text-xs text-slate-500 italic">Ch∆∞a c√≥</div>
                </div>
            </div>
        </div>

        <div class="absolute bottom-4 left-4 pointer-events-none flex flex-col gap-4">
            <div id="panel-container" class="pointer-events-auto">
                <!-- Panels will be injected here by JS -->
            </div>
            <div class="flex gap-4 pointer-events-auto">
                <button id="toggle-upgrades" class="toggle-button" title="N√¢ng C·∫•p">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                </button>
                 <button id="toggle-gacha" class="toggle-button" title="Quay Th∆∞·ªüng">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a7 7 0 1 0 10 7"/></svg>
                </button>
                 <button id="toggle-equipment" class="toggle-button" title="Trang b·ªã">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                </button>
                <button id="toggle-dungeon" class="toggle-button" title="Dungeon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 10l-4 4 6 6h6v-6l-4-4Z"/><path d="M4.5 11.5L2 14l3 3 2.5-2.5"/><path d="m18 2 4 4"/><path d="m2 2 4 4"/><path d="M21.5 14.5L19 12l-3 3 2.5 2.5"/><path d="M10 22l-6-6"/></svg>
                </button>
                <button id="toggle-stats" class="toggle-button" title="Th·ªëng k√™">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
                </button>
                <button id="toggle-music" class="toggle-button" title="√Çm nh·∫°c">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                </button>
            </div>
        </div>
    </div>
    
    <div id="gacha-modal">
        <div id="gacha-result-container" class="gacha-container"></div>
    </div>

    <div id="dungeon-combat-modal">
        <div id="dungeon-combat-container"></div>
    </div>

    <!-- Panel Templates -->
    <template id="template-upgrades">
        <div class="panel">
             <div class="tab-container">
                <button class="tab-button active" data-tab="player-content">B·∫°n</button>
                <button class="tab-button" data-tab="miners-content">Th·ª£ m·ªè</button>
                <button class="tab-button" data-tab="agents-content">Agent</button>
            </div>
            <div id="upgrades-content-container">
                <div id="player-content" class="tab-content space-y-3">
                    <div>
                        <h3 class="upgrade-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m14.5 5.5 5 5a2 2 0 0 1 0 2.82l-5 5a2 2 0 0 1-2.82 0l-5-5a2 2 0 0 1 0-2.82l5-5a2 2 0 0 1 2.82 0z"/><path d="m12 12 5 5"/><path d="M2 21h6"/><path d="m17 14-4-4"/></svg>
                            <span>N√¢ng c·∫•p Cu·ªëc <span class="text-sm text-slate-400">(Lv. <span id="clickPowerStat">1</span>)</span></span>
                        </h3>
                        <button id="upgradeClick" class="btn-primary"><span id="upgradeClickCost">20 $</span></button>
                    </div>
                     <div>
                        <h3 class="upgrade-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 3h6l3 3v12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V6Z"/><path d="M9 3V1h6v2"/><path d="M10 12h4"/><path d="M12 10v4"/></svg>
                            <span>ƒê√†o Nhi·ªÅu √î <span class="text-sm text-slate-400">(Lv. <span id="mineMultiLevelStat">0</span>)</span></span>
                        </h3>
                        <button id="upgradeMineMulti" class="btn-primary"><span id="upgradeMineMultiCost">500 $</span></button>
                    </div>
                     <div>
                        <h3 class="upgrade-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 2.1l4 4-4 4"/><path d="M3 12.6A9 9 0 0 1 12 3a9 9 0 0 1 8.4 5.4"/><path d="M7 21.9l-4-4 4-4"/><path d="M21 11.4A9 9 0 0 1 12 21a9 9 0 0 1-8.4-5.4"/></svg>
                            <span>T·ª± ƒê·ªông ƒê√†o <span class="text-sm text-slate-400">(Lv. <span id="autoMineLevelStat">0</span>)</span></span>
                        </h3>
                        <button id="upgradeAutoMine" class="btn-primary"><span id="upgradeAutoMineCost">100 $</span></button>
                    </div>
                </div>
                <div id="miners-content" class="tab-content space-y-3 hidden">
                     <div>
                        <h3 class="upgrade-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            <span>Thu√™ Th·ª£ M·ªè <span class="text-sm text-slate-400">(<span id="minerCountStat">0</span>/5)</span></span>
                        </h3>
                        <button id="hireMiner" class="btn-primary"><span id="hireMinerCost">50 $</span></button>
                    </div>
                    <div>
                        <h3 class="upgrade-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3.5 21 14 10.5 21 21"/><path d="M21 3.5 10.5 14 3.5 3.5"/></svg>
                            <span>S·ª©c M·∫°nh <span class="text-sm text-slate-400">(Lv. <span id="minerPowerLevelStat">1</span>)</span></span>
                        </h3>
                        <button id="upgradeMinerPower" class="btn-primary"><span id="upgradeMinerPowerCost">200 $</span></button>
                    </div>
                     <div>
                        <h3 class="upgrade-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 2 3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                            <span>Si√™u C·∫•p <span class="text-sm text-slate-400">(Lv. <span id="superMinerLevelStat">0</span>/5)</span></span>
                        </h3>
                        <button id="upgradeSuperMiner" class="btn-primary"><span id="upgradeSuperMinerCost">2000 $</span></button>
                    </div>
                     <div>
                        <h3 class="upgrade-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                            <span>Th·ªÉ L·ª±c <span class="text-sm text-slate-400">(Lv. <span id="minerStaminaLevelStat">0</span>)</span></span>
                        </h3>
                        <button id="upgradeMinerStamina" class="btn-primary"><span id="upgradeMinerStaminaCost">300 $</span></button>
                    </div>
                </div>
                <div id="agents-content" class="tab-content hidden">
                    <div class="flex items-start gap-4">
                        <img src="https://www.pngmart.com/files/24/Tung-Tung-Tung-Sahur-PNG-Photos.png" class="w-20 h-20 object-contain bg-slate-900/50 rounded-lg p-1" alt="Agent Tung tung tung sahuer">
                        <div class="flex-1">
                            <h3 class="font-bold text-lg">Tung tung tung sahuer</h3>
                            <p class="text-sm text-slate-400 mb-2">Ph√° h·ªßy m·ªôt kh·ªëi t√πy ch·ªçn ngay l·∫≠p t·ª©c. H·ªìi chi√™u: 60s.</p>
                            <div id="agentTungContainer">
                                <!-- Agent button is rendered dynamically by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="template-stats">
        <div class="panel max-h-[80vh] overflow-y-auto custom-scrollbar">
            <h2 class="font-bold text-lg text-center border-b border-slate-600 pb-2 mb-3">Th·ªëng K√™ Chi Ti·∫øt</h2>
            <div class="space-y-4">
                <div>
                    <h3 class="font-semibold text-base text-amber-400 mb-1">Chung</h3>
                    <div class="stat-item"><span>‚õèÔ∏è T·∫ßng ƒë√£ ƒë√†o:</span> <span id="depthStat" class="font-bold text-purple-400">0</span></div>
                    <div class="stat-item"><span>üïí Th·ªùi gian ch∆°i:</span> <span id="timePlayed" class="font-bold">00:00:00</span></div>
                    <div class="stat-item"><span>üíé T·ªïng kh·ªëi ƒë√£ ƒë√†o:</span> <span id="blocksMined" class="font-bold">0</span></div>
                </div>
                <div>
                    <h3 class="font-semibold text-base text-green-400 mb-1">Kinh T·∫ø</h3>
                    <div class="stat-item"><span>üìà Ti·ªÅn ki·∫øm ƒë∆∞·ª£c:</span> <span id="moneyEarned" class="font-bold">0 $</span></div>
                    <div class="stat-item"><span>üìâ Ti·ªÅn ƒë√£ ti√™u:</span> <span id="moneySpent" class="font-bold">0 $</span></div>
                </div>
                <div>
                    <h3 class="font-semibold text-base text-cyan-400 mb-1">Th∆∞·ªüng T·ª´ Hero</h3>
                    <div class="stat-item"><span>üí∞ Ti·ªÅn c·ªông/kh·ªëi:</span> <span id="heroFlatBonusStat" class="font-bold text-green-400">+0 $</span></div>
                    <div class="stat-item"><span>‚úñÔ∏è H·ªá s·ªë nh√¢n ti·ªÅn:</span> <span id="heroMultiplierStat" class="font-bold text-green-400">x1.00</span></div>
                </div>
                 <div>
                    <h3 class="font-semibold text-base text-red-400 mb-1">Chi·∫øn ƒë·∫•u (Dungeon)</h3>
                    <div class="stat-item"><span>‚öîÔ∏è S√°t th∆∞∆°ng:</span> <span id="playerDamageStat" class="font-bold">1</span></div>
                </div>
                <div>
                    <h3 class="font-semibold text-base text-blue-400 mb-1">Kh·ªëi ƒê√£ ƒê√†o</h3>
                    <div id="mined-blocks-stats" class="space-y-1">
                        <p class="text-slate-400 text-center">Ch∆∞a c√≥ d·ªØ li·ªáu.</p>
                    </div>
                </div>
                 <div class="pt-3 border-t border-slate-600">
                     <h3 class="font-semibold mb-2">Giftcode</h3>
                     <div class="flex gap-2">
                         <input id="giftcode-input" type="text" class="bg-slate-900/50 rounded-md px-2 py-1 flex-grow text-white" placeholder="Nh·∫≠p code...">
                         <button id="giftcode-submit" class="btn-primary !w-auto px-4">OK</button>
                     </div>
                     <p id="giftcode-message" class="text-sm text-center mt-2 h-4"></p>
                </div>
            </div>
        </div>
    </template>
    
    <template id="template-gacha">
        <div class="panel">
            <div id="gacha-banner-list" class="space-y-2 mb-4">
                <!-- Banner list will be rendered here -->
            </div>
            <div id="gacha-banner-content">
                <p class="text-slate-400 text-center">Ch·ªçn m·ªôt banner ƒë·ªÉ xem chi ti·∫øt.</p>
            </div>
        </div>
    </template>

    <template id="template-heroes">
        <div class="panel">
            <h2 class="font-bold text-lg border-b border-slate-600 pb-1 mb-2">Trang b·ªã Hero (<span id="equipped-count">0</span>/3)</h2>
            <div id="hero-collection" class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                <p class="text-slate-400 text-center">Ch∆∞a c√≥ hero n√†o. H√£y quay th∆∞·ªüng!</p>
            </div>
        </div>
    </template>

    <template id="template-dungeon">
        <div class="panel">
            <h2 class="font-bold text-lg text-center border-b border-slate-600 pb-2 mb-3">Dungeon</h2>
            <div class="text-center">
                <p class="text-slate-400">T·∫ßng cao nh·∫•t:</p>
                <p id="dungeon-highest-floor" class="text-4xl font-bold text-amber-400 mb-4">0</p>
                <button id="start-dungeon-btn" class="btn-primary">B·∫Øt ƒë·∫ßu</button>
            </div>
        </div>
    </template>

    <template id="template-equipment">
        <div class="panel !max-w-md">
            <h2 class="font-bold text-lg border-b border-slate-600 pb-1 mb-3">Trang B·ªã</h2>
            
            <!-- Heroes Section -->
            <div class="mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-amber-400 font-semibold">Anh H√πng (<span id="equipped-hero-count">0</span>/3)</h3>
                    <div class="text-xs text-slate-400">Click ƒë·ªÉ trang b·ªã/g·ª°</div>
                </div>
                <div id="hero-collection" class="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto custom-scrollbar">
                    <!-- Hero items will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Artifacts Section -->
            <div>
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-cyan-400 font-semibold">Di V·∫≠t (<span id="equipped-artifact-count">0</span>/2)</h3>
                    <div class="text-xs text-slate-400">Click ƒë·ªÉ trang b·ªã/g·ª°</div>
                </div>
                <div id="artifact-collection" class="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto custom-scrollbar">
                    <!-- Artifact items will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </template>

    <template id="template-music">
        <div class="panel">
            <h2 class="font-bold text-lg border-b border-slate-600 pb-1 mb-2">√Çm nh·∫°c n·ªÅn</h2>
            <div class="space-y-4">
                <!-- Current Track Info -->
                <div class="text-center">
                    <div class="text-sm text-slate-400 mb-1">ƒêang ph√°t</div>
                    <div id="current-track-name" class="font-semibold text-amber-400">Track 1</div>
                </div>
                
                <!-- Music Controls -->
                <div class="flex items-center justify-center gap-3">
                    <button id="music-prev" class="toggle-button" title="B√†i tr∆∞·ªõc">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="19,20 9,12 19,4"/><line x1="5" y1="19" x2="5" y2="5"/></svg>
                    </button>
                    <button id="music-play-pause" class="toggle-button active" title="Ph√°t/T·∫°m d·ª´ng">
                        <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5,3 19,12 5,21"/></svg>
                        <svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
                    </button>
                    <button id="music-next" class="toggle-button" title="B√†i ti·∫øp">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5,4 15,12 5,20"/><line x1="19" y1="5" x2="19" y2="19"/></svg>
                    </button>
                </div>
                
                <!-- Volume Control -->
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <span>√Çm l∆∞·ª£ng</span>
                        <span id="volume-display">16%</span>
                    </div>
                    <input type="range" id="volume-slider" min="0" max="100" value="16" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer slider">
                </div>
                
                <!-- Track List -->
                <div class="space-y-2">
                    <div class="text-sm font-semibold text-slate-300">Danh s√°ch b√†i h√°t</div>
                    <div id="track-list" class="space-y-1 max-h-32 overflow-y-auto custom-scrollbar">
                        <!-- Track items will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // --- DOM Elements ---
        let moneyEl, panelContainer, canvas, notificationContainer;
        let toggleButtons = {};
        let audioPlayer = null;
        
        // --- Game State ---
        let state = {
            resources: { money: 200000 },
            stats: { 
                timePlayed: 0,
                blocksMined: 0,
                moneyEarned: 0,
                moneySpent: 0,
                minedBlockCounts: {},
                pityCounters: {
                    hyper: 80,
                    allstars: 80,
                    ultimate: 80,
                },
            },
            upgrades: { 
                clickPower: 1, 
                mineMultiLevel: 0,
                autoMineLevel: 0,
                minerCount: 0,
                minerPowerLevel: 1,
                superMinerLevel: 0,
                minerStaminaLevel: 0,
            },
            agents: {
                tung: { owned: false, cooldown: 0, isTargeting: false }
            },
            heroes: {
                collection: ['naruto', 'sukuna'], // Test data
                equipped: ['naruto'], // Test data
            },
            dungeon: {
                highestFloor: 0,
                currentRun: null,
            },
            artifacts: {
                collection: ['sword', 'shield'], // Test data
                equipped: ['sword'], // Test data
            },
            music: {
                currentTrack: 0,
                isPlaying: false,
                volume: 0.16,
                tracks: [
                    { name: 'Track 1', file: 'music/track-1.mp3' },
                    { name: 'Track 2', file: 'music/track-2.mp3' },
                    { name: 'Track 3', file: 'music/track-3.mp3' },
                    { name: 'Track 4', file: 'music/track-4.mp3' },
                    { name: 'Track 5', file: 'music/track-5.mp3' },
                    { name: 'Track 6', file: 'music/track-6.mp3' }
                ]
            },
            depth: 0,
            usedCodes: [],
            activeBanner: null,
        };
        let activePanel = null;
        let isGachaAnimating = false;
        let dungeonTimerInterval = null;

        // --- Game Config ---
        const MINE_COLS = 8;
        const MINE_ROWS = 8;
        const MINE_HEIGHT = 10;
        const BLOCK_SIZE = 1;
        const BLOCK_TYPES = {
            grass: { name: 'C·ªè', health: 54, color: 0x6a994e, sellValue: 7.2 },
            dirt: { name: 'ƒê·∫•t', health: 36, color: 0x966919, sellValue: 7.2 },
            stone: { name: 'ƒê√°', health: 50, color: 0x718096, sellValue: 14.4, deepGradient: ['#333333', '#111111'] },
            copper: { name: 'ƒê·ªìng', health: 180, sellValue: 25.2, gradient: ['#16a34a', '#ca8a04'] },
            coal: { name: 'Than', health: 288, color: 0x2d3748, sellValue: 43.2 },
            lapis: { name: 'Lapis', health: 432, sellValue: 108, color: 0x1e40af, deepGradient: ['#000000', '#1e40af'] },
            gold: { name: 'V√†ng', health: 720, color: 0xf6e05e, sellValue: 216 },
            ruby: { name: 'Ruby', health: 1080, color: 0xe0115f, sellValue: 432 },
            emerald: { name: 'Ng·ªçc L·ª•c B·∫£o', health: 1440, sellValue: 756, color: 0x10b981, deepGradient: ['#064e3b', '#065f46'] },
            rossara: { name: 'Rossara', health: 2160, sellValue: 1296, gradient: ['#db2777', '#9333ea'] },
            diamond: { name: 'Kim C∆∞∆°ng', health: 2880, color: 0x00ffff, sellValue: 2160 },
            obsidian: { name: 'Obsidian', health: 7200, sellValue: 1500, color: 0x281c3b, deepGradient: ['#000000', '#4c1d95'] },
            crystal: { name: 'Crystal', health: 7000, sellValue: 12000, gradient: ['#4c1d95', '#a855f7'] },
            uranious: { name: 'Uranious', health: 8000, sellValue: 14000, gradient: ['#000000', '#166534'] },
            bonreus: { name: 'Bonreus', health: 9000, sellValue: 15000, gradient: ['#ffffff', '#1e293b'] },
            darkium: { name: 'Darkium', health: 11000, sellValue: 17500, gradient: ['#ef4444', '#000000'] }
        };
        
        const HERO_DATA = {
            naruto: { id: 'naruto', name: 'Naruto', rarity: 'Common', image: 'https://photo-resize-zmp3.zadn.vn/w600_r1x1_jpeg/cover/1/9/5/7/19571506525e47f5b79977c1fc20cec1.jpg', bonusType: 'flat', bonusValue: 2, bonusText: '+2$ m·ªói kh·ªëi' },
            nobara: { id: 'nobara', name: 'Nobara', rarity: 'Common', image: 'https://cdn.rafled.com/anime-icons/images/15b724c33ed746795f3700cd90b7c4951cafd54d05abc08fe14e3dc0b1a3fa93.jpg', bonusType: 'flat', bonusValue: 2, bonusText: '+2$ m·ªói kh·ªëi' },
            sukuna: { id: 'sukuna', name: 'Sukuna', rarity: 'Rare', image: 'https://i.pinimg.com/736x/04/f8/fd/04f8fdc99be9bf05db546d77f09e2509.jpg', bonusType: 'flat', bonusValue: 5, bonusText: '+5$ m·ªói kh·ªëi' },
            kakashi: { id: 'kakashi', name: 'Kakashi', rarity: 'Rare', image: 'https://i.pinimg.com/736x/46/c4/70/46c47013059023669fd998ec3d8ac269.jpg', bonusType: 'flat', bonusValue: 5, bonusText: '+5$ m·ªói kh·ªëi' },
            itadori: { id: 'itadori', name: 'Itadori', rarity: 'Epic', image: 'https://i.scdn.co/image/ab67616d0000b273e5525e7a8334a094ea129aa1', bonusType: 'flat', bonusValue: 10, bonusText: '+10$ m·ªói kh·ªëi' },
            yuta: { id: 'yuta', name: 'Yuta', rarity: 'Legend', image: 'https://i1.sndcdn.com/artworks-ZSy6Igf6byo3ZRgS-G7Lx1Q-t500x500.jpg', bonusType: 'flat', bonusValue: 20, bonusText: '+20$ m·ªói kh·ªëi' },
            gojo: { id: 'gojo', name: 'Gojo', rarity: 'Mythic', image: 'https://i.scdn.co/image/ab67616d00001e02be8d8aa9fcd65c5f40351a96', bonusType: 'multiplier', bonusValue: 1.5, bonusText: 'x1.5 t·ªïng ti·ªÅn' },
            megumi: { id: 'megumi', name: 'Megumi', rarity: 'Secret', image: 'https://i.pinimg.com/736x/d8/62/be/d862bec8ab6702ebb71024d07a323af1.jpg', bonusType: 'flat', bonusValue: 50, bonusText: '+50$ m·ªói kh·ªëi' },
            itachi: { id: 'itachi', name: 'Itachi', rarity: 'Common', image: 'https://4kwallpapers.com/images/wallpapers/itachi-uchiha-2048x2048-19971.jpg', bonusType: 'flat', bonusValue: 15, bonusText: '+15$ m·ªói kh·ªëi' },
            nanami: { id: 'nanami', name: 'Nanami', rarity: 'Common', image: 'https://i.pinimg.com/736x/d2/b2/90/d2b290e8cf7898eefdd64b68ae477849.jpg', bonusType: 'flat', bonusValue: 17, bonusText: '+17$ m·ªói kh·ªëi' },
            zoro: { id: 'zoro', name: 'Zoro', rarity: 'Rare', image: 'https://i.pinimg.com/736x/f0/71/dc/f071dc841f593eb7af5b9aed7dd2aaac.jpg', bonusType: 'flat', bonusValue: 25, bonusText: '+25$ m·ªói kh·ªëi' },
            bakugo: { id: 'bakugo', name: 'Bakugo', rarity: 'Rare', image: 'https://i.pinimg.com/736x/03/4a/a7/034aa76d0892d3f421f25ed8116d186f.jpg', bonusType: 'flat', bonusValue: 28, bonusText: '+28$ m·ªói kh·ªëi' },
            'jinwoo': { id: 'jinwoo', name: 'Jin Woo', rarity: 'Epic', image: 'https://img.asmedia.epimg.net/resizer/v2/CQQFFTMTVFAWRGOUSQWHFR4CLY.png?auth=ceff9904f42b7a9c324f2b49ed90b343dfcf411d9688e66ad081acb3197af62a&width=1200&height=1200&smart=true', bonusType: 'flat', bonusValue: 40, bonusText: '+40$ m·ªói kh·ªëi' },
            levi: { id: 'levi', name: 'Levi', rarity: 'Legend', image: 'https://static.wikia.nocookie.net/shingekinokyojin/images/0/0a/Levi_Ackermann_%28Anime%29_character_image_%28854%29.png/revision/latest?cb=20231106070611', bonusType: 'flat', bonusValue: 60, bonusText: '+60$ m·ªói kh·ªëi' },
            luffy: { id: 'luffy', name: 'Luffy', rarity: 'Mythic', image: 'https://i.redd.it/shigaraki-vs-luffy-who-wins-v0-pct4a10f4yve1.jpg?width=1920&format=pjpg&auto=webp&s=731df8ebfb170581b1c7a6c31d3e662406f8bd5a', bonusType: 'multiplier', bonusValue: 2, bonusText: 'x2 t·ªïng ti·ªÅn' },
            goku: { id: 'goku', name: 'Goku', rarity: 'Secret', image: 'https://bleedingcool.com/wp-content/uploads/2020/01/ultra-instinct-goku-900x900.jpg', bonusType: 'flat', bonusValue: 500, bonusText: '+500$ m·ªói kh·ªëi' },
            inosuke: { id: 'inosuke', name: 'Inosuke', rarity: 'Common', image: 'https://i.redd.it/inosuke-hashibira-demon-slayer-vs-arataki-itto-genshin-v0-t4q1wave4kue1.jpg?width=1200&format=pjpg&auto=webp&s=c9b66a28dd74b075b79b9fded15d18d169ded4b5', bonusType: 'flat', bonusValue: 60, bonusText: '+60$ m·ªói kh·ªëi' },
            vegeta: { id: 'vegeta', name: 'Vegeta', rarity: 'Common', image: 'https://i1.sndcdn.com/artworks-000118701077-tvmk00-t1080x1080.jpg', bonusType: 'flat', bonusValue: 62, bonusText: '+62$ m·ªói kh·ªëi' },
            sanji: { id: 'sanji', name: 'Sanji', rarity: 'Rare', image: 'https://i.pinimg.com/736x/e6/e5/c5/e6e5c5eddc5cb3ea5e75ad568b1b54bb.jpg', bonusType: 'flat', bonusValue: 84, bonusText: '+84$ m·ªói kh·ªëi' },
            ichigo: { id: 'ichigo', name: 'Ichigo', rarity: 'Epic', image: 'https://www.animedep.com/wp-content/uploads/2025/05/anh-kurosaki-ichigo-2.webp', bonusType: 'flat', bonusValue: 120, bonusText: '+120$ m·ªói kh·ªëi' },
            saitama: { id: 'saitama', name: 'Saitama', rarity: 'Legend', image: 'https://res09.bignox.com/moniqi-blog/vn-bignox-blog/2024/02/420018521_323264464024661_7705485423494122913_n.jpg', bonusType: 'flat', bonusValue: 240, bonusText: '+240$ m·ªói kh·ªëi' },
            rimuru: { id: 'rimuru', name: 'Rimuru', rarity: 'Legend', image: 'https://images.steamusercontent.com/ugc/2055374656768151949/38C6ADE1BF2310E881082AD8ACD1557E4196EBF2/?imw=512&&ima=fit&impolicy=Letterbox&imcolor=%23000000&letterbox=false', bonusType: 'flat', bonusValue: 240, bonusText: '+240$ m·ªói kh·ªëi' },
            rengoku: { id: 'rengoku', name: 'Rengoku', rarity: 'Mythic', image: 'https://www.animedep.com/wp-content/uploads/2025/07/anh-rengoku-6.webp', bonusType: 'multiplier', bonusValue: 2.5, bonusText: 'x2.5 t·ªïng ti·ªÅn' },
        };

        const GACHA_BANNERS = {
            hyper: {
                id: 1, name: "Banner 1: Hyper - D√†nh cho newbie", cost: 1000, refundRate: 0.2,
                rates: { Common: 0.66, Rare: 0.22, Epic: 0.078, Legend: 0.03, Mythic: 0.01, Secret: 0.002 },
                pool: { Common: ['naruto', 'nobara'], Rare: ['sukuna', 'kakashi'], Epic: ['itadori'], Legend: ['yuta'], Mythic: ['gojo'], Secret: ['megumi'] }
            },
            allstars: {
                id: 2, name: "Banner 2: All Stars", cost: 50000, refundRate: 0.2,
                rates: { Common: 0.66, Rare: 0.22, Epic: 0.078, Legend: 0.03, Mythic: 0.01, Secret: 0.002 },
                pool: { Common: ['itachi', 'nanami'], Rare: ['zoro', 'bakugo'], Epic: ['jinwoo'], Legend: ['levi'], Mythic: ['luffy'], Secret: ['goku'] }
            },
            ultimate: {
                id: 3, name: "Banner 3: Ultimate Saga", cost: 250000, refundRate: 0.2,
                rates: { Common: 0.658, Rare: 0.22, Epic: 0.08, Legend: 0.03, Mythic: 0.012 },
                pool: { Common: ['inosuke', 'vegeta'], Rare: ['sanji'], Epic: ['ichigo'], Legend: ['saitama', 'rimuru'], Mythic: ['rengoku'] }
            }
        };

        const ARTIFACT_DATA = {
            sword: { id: 'sword', name: 'Ki·∫øm G·ªâ', rarity: 'Common', image: 'https://cdn-icons-png.flaticon.com/512/1086/1086942.png', bonusType: 'damage', bonusValue: 2, bonusText: '+2 S√°t th∆∞∆°ng' },
            shield: { id: 'shield', name: 'Khi√™n G·ªó', rarity: 'Common', image: 'https://cdn-icons-png.flaticon.com/512/1086/1086953.png', bonusType: 'damage', bonusValue: 1, bonusText: '+1 S√°t th∆∞∆°ng' },
            iron_sword: { id: 'iron_sword', name: 'Ki·∫øm S·∫Øt', rarity: 'Rare', image: 'https://cdn-icons-png.flaticon.com/512/2927/2927977.png', bonusType: 'damage', bonusValue: 5, bonusText: '+5 S√°t th∆∞∆°ng' },
            magic_ring: { id: 'magic_ring', name: 'Nh·∫´n Ph√©p', rarity: 'Epic', image: 'https://cdn-icons-png.flaticon.com/512/189/189712.png', bonusType: 'damage', bonusValue: 10, bonusText: '+10 S√°t th∆∞∆°ng' },
            dragon_scale: { id: 'dragon_scale', name: 'V·∫£y R·ªìng', rarity: 'Legend', image: 'https://cdn-icons-png.flaticon.com/512/868/868648.png', bonusType: 'damage', bonusValue: 25, bonusText: '+25 S√°t th∆∞∆°ng' },
        };

        const DUNGEON_MINIONS = [
            'https://cdn-icons-png.flaticon.com/512/3050/3050734.png', // Slime
            'https://cdn-icons-png.flaticon.com/512/167/167243.png',   // Goblin
            'https://cdn-icons-png.flaticon.com/512/3503/3503849.png', // Skeleton
            'https://cdn-icons-png.flaticon.com/512/993/993539.png',   // Orc
        ];
        
        const DUNGEON_BOSSES = [
            { name: 'Jogo', image: 'https://static.wikia.nocookie.net/discordscaling/images/c/c7/Jogo.webp/revision/latest?cb=20240905031146' },
            { name: 'Mahito', image: 'https://www.anime-colors.com/wp-content/uploads/mahito.png' },
            { name: 'Geto', image: 'https://wibu.com.vn/wp-content/uploads/2025/02/Geto-Suguru.png' },
            { name: 'Akainu', image: 'https://opbr-en.bn-ent.net/assets/data/webp/character/0032_2d.png.webp' },
            { name: 'Katakuri', image: 'https://opbr-en.bn-ent.net/assets/data/webp/character/0031_2d.png.webp' },
            { name: 'Onochimaru', image: 'https://wibu.com.vn/wp-content/uploads/2024/04/Orochimaru-Naruto.png' },
            { name: 'Obito', image: 'https://wibu.com.vn/wp-content/uploads/2024/04/obito.png' },
            { name: 'Akaza', image: 'https://pngdownload.io/wp-content/uploads/2024/01/Akaza-Upper-Moon-Three-from-Demon-Slayer-anime-transparent-PNG-image-jpg.webp' },
            { name: 'Douma', image: 'https://wibu.com.vn/wp-content/uploads/2024/04/Douma.png' },
            { name: 'Hilichurl', image: 'https://genshinimpact.wiki.fextralife.com/file/Genshin-Impact/hilichurl_icon.png' },
            { name: 'Slime', image: 'https://genshinimpact.wiki.fextralife.com/file/Genshin-Impact/anemo_slime_icon.png' },
            { name: 'Ruin Guard', image: 'https://genshinimpact.wiki.fextralife.com/file/Genshin-Impact/ruin_guard_icon.png' },
            { name: 'Fatui', image: 'https://genshinimpact.wiki.fextralife.com/file/Genshin-Impact/fatui_pyro_agent_icon.png' },
            { name: 'Rifthound', image: 'https://genshinimpact.wiki.fextralife.com/file/Genshin-Impact/rockfond_rifthound_icon.png' },
            { name: 'Maguu Kenki', image: 'https://genshinimpact.wiki.fextralife.com/file/Genshin-Impact/maguu_kenki_icon.png' }
        ];


        // --- 3D Scene Variables ---
        let scene, camera, renderer, raycaster, mouse;
        let mineGrid = [];
        let mineMeshes = [];
        let particles = [];
        let shrinkingBlocks = [];
        let visualMiners = [];
        let autoMineTimer = 0;
        let autoMineTargetIndex = 0;
        
        // --- Utility Functions ---
        function formatMoney(n) {
            if (n < 1e3) return n.toFixed(0);
            if (n >= 1e3 && n < 1e6) return +(n / 1e3).toFixed(1) + "K";
            if (n >= 1e6 && n < 1e9) return +(n / 1e6).toFixed(1) + "M";
            if (n >= 1e9 && n < 1e12) return +(n / 1e9).toFixed(1) + "B";
            return n.toExponential(2);
        }

        function initThreeJS() {
            scene = new THREE.Scene();
            scene.background = null;
            const aspect = window.innerWidth / window.innerHeight;
            const viewSize = MINE_COLS * 2.0;
            const halfViewSize = viewSize / 2;
            camera = new THREE.OrthographicCamera(-halfViewSize * aspect, halfViewSize * aspect, halfViewSize, -halfViewSize, -100, 100);
            camera.position.set(12, 12, 12);
            const centerX = (MINE_COLS-1) * BLOCK_SIZE / 2;
            const centerZ = (MINE_ROWS-1) * BLOCK_SIZE / 2;
            camera.lookAt(centerX, -MINE_HEIGHT/2, centerZ);
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.9);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
            directionalLight.position.set(10, 20, 15);
            scene.add(directionalLight);
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();
            window.addEventListener('resize', onWindowResize, false);
            canvas.addEventListener('click', onCanvasClick, false);
        }

        // --- Game Logic ---
        function getBlockType(isTopLayer, currentDepth) {
            if (isTopLayer) return 'grass';
            if (currentDepth >= 100) {
                const DEEP_ORE_SPAWN_RANGES = { darkium: { min: 125, max: 150 }, bonreus: { min: 125, max: 150 }, uranious: { min: 100, max: 125 }, crystal: { min: 100, max: 125 } };
                const DEEP_ORE_CHANCE = 0.01;
                for (const ore in DEEP_ORE_SPAWN_RANGES) {
                    const config = DEEP_ORE_SPAWN_RANGES[ore];
                    if (currentDepth >= config.min && currentDepth <= config.max && Math.random() < DEEP_ORE_CHANCE) return ore;
                }
            }
            const ORE_SPAWN_RANGES = { diamond:  { min: 80, max: 100 }, ruby: { min: 80, max: 100 }, rossara: { min: 50, max: 75 }, emerald: { min: 50, max: 75 }, lapis: { min: 20, max: 40 }, copper: { min: 20, max: 40 }, gold: { min: 40, max: 100 }, coal: { min: 30, max: 80 }, obsidian: { min: 40, max: 120 } };
            const IN_RANGE_CHANCE = 0.01, OUT_OF_RANGE_CHANCE = 0.00006;
            const oreCheckOrder = ['diamond', 'ruby', 'rossara', 'emerald', 'obsidian', 'gold', 'lapis', 'copper', 'coal'];
            for (const ore of oreCheckOrder) {
                const config = ORE_SPAWN_RANGES[ore];
                let chance = (config && currentDepth >= config.min && currentDepth <= config.max) ? IN_RANGE_CHANCE : OUT_OF_RANGE_CHANCE;
                if (Math.random() < chance) return ore;
            }
            if (currentDepth > 100) return 'stone';
            if (currentDepth > 5 || (currentDepth > 2 && Math.random() < 0.6)) return 'stone';
            return 'dirt';
        }

        function createBlockData(isTopLayer, currentDepth) {
            const blockTypeName = getBlockType(isTopLayer, currentDepth);
            const blockType = BLOCK_TYPES[blockTypeName];
            let health = blockType.health;
            if (currentDepth >= 100) health += 5000;
            return { type: blockTypeName, health: health, maxHealth: health };
        }
        
        function createGradientMaterial(color1, color2) {
            const canvas = document.createElement('canvas');
            canvas.width = 64; canvas.height = 64;
            const context = canvas.getContext('2d');
            const gradient = context.createLinearGradient(0, 0, 0, 64);
            gradient.addColorStop(0, color1); gradient.addColorStop(1, color2);
            context.fillStyle = gradient; context.fillRect(0, 0, 64, 64);
            const texture = new THREE.CanvasTexture(canvas);
            return new THREE.MeshStandardMaterial({ map: texture });
        }

        function createBlockMesh(x, y, z, blockData, currentDepth) {
            const geometry = new THREE.BoxGeometry(BLOCK_SIZE * 0.95, BLOCK_SIZE * 0.95, BLOCK_SIZE * 0.95);
            const blockTypeInfo = BLOCK_TYPES[blockData.type];
            let material;
            const isDeep = currentDepth >= 100;
            if (isDeep && blockTypeInfo.deepGradient) material = createGradientMaterial(...blockTypeInfo.deepGradient);
            else if (blockTypeInfo.gradient) material = createGradientMaterial(...blockTypeInfo.gradient);
            else {
                const baseColor = new THREE.Color(blockTypeInfo.color);
                const hsl = {}; baseColor.getHSL(hsl); hsl.l += (Math.random() - 0.5) * 0.1;
                baseColor.setHSL(hsl.h, hsl.s, hsl.l);
                material = new THREE.MeshStandardMaterial({ color: baseColor });
            }
            const mesh = new THREE.Mesh(geometry, material);
            mesh.position.set(x * BLOCK_SIZE, -y * BLOCK_SIZE, z * BLOCK_SIZE);
            mesh.userData = { gridX: x, gridY: y, gridZ: z, targetYScale: 1.0, targetYPosition: -y * BLOCK_SIZE, isFlashing: false, flashTime: 0 };
            return mesh;
        }

        function initializeMine() {
            for (let y = 0; y < MINE_HEIGHT; y++) {
                const layerData = [], layerMeshes = [];
                const currentDepth = state.depth + y;
                for (let z = 0; z < MINE_ROWS; z++) {
                    for (let x = 0; x < MINE_COLS; x++) {
                        const blockData = createBlockData(y === 0, currentDepth);
                        const mesh = createBlockMesh(x, y, z, blockData, currentDepth);
                        layerData.push(blockData); layerMeshes.push(mesh); scene.add(mesh);
                    }
                }
                mineGrid.push(layerData); mineMeshes.push(layerMeshes);
            }
        }

        function digBlock(x, y, z, power, isPlayerAction = false, isSuperMiner = false) {
            if (y < 0 || y >= MINE_HEIGHT) return;
            const index = z * MINE_COLS + x;
            if (!mineGrid[y] || !mineGrid[y][index]) return;
            const blockData = mineGrid[y][index];
            const mesh = mineMeshes[y][index];
            if (!mesh || blockData.health <= 0) return;
            blockData.health -= power;
            mesh.userData.isFlashing = true; mesh.userData.flashTime = 0.15;
            if (mesh.material.emissive) mesh.material.emissive.setHex(0xffffff);
            createHitParticles(mesh.position, mesh.material.color || 0xffffff);
            if (blockData.health <= 0) {
                const blockTypeInfo = BLOCK_TYPES[blockData.type];
                let moneyGained = blockTypeInfo.sellValue;
                const currentBlockDepth = state.depth + y; 
                if (currentBlockDepth < 100) moneyGained += ['grass', 'dirt', 'stone'].includes(blockData.type) ? 50 : 300;
                else moneyGained += 400;
                const depthBonus = 1 + (Math.floor(state.depth / 10) * 0.01);
                moneyGained *= depthBonus;
                let flatBonus = 0, multiplier = 1;
                state.heroes.equipped.forEach(heroId => {
                    const hero = HERO_DATA[heroId];
                    if (hero.bonusType === 'flat') flatBonus += hero.bonusValue;
                    else if (hero.bonusType === 'multiplier') multiplier *= hero.bonusValue;
                });
                moneyGained = Math.round((moneyGained + flatBonus) * multiplier);
                state.stats.blocksMined++;
                state.stats.minedBlockCounts[blockData.type] = (state.stats.minedBlockCounts[blockData.type] || 0) + 1;
                state.resources.money += moneyGained;
                state.stats.moneyEarned += moneyGained;
                moneyEl.classList.add('money-flash');
                setTimeout(() => moneyEl.classList.remove('money-flash'), 200);
                shrinkingBlocks.push(mesh);
                mineMeshes[y][index] = null;
                checkRowsCleared();
            } else {
                mesh.userData.targetYScale = blockData.health / blockData.maxHealth;
            }
            const multiLevel = isPlayerAction ? state.upgrades.mineMultiLevel : (isSuperMiner ? state.upgrades.superMinerLevel : 0);
            if (multiLevel > 0 && y === 0) {
                const splashDamage = power * 0.25 * multiLevel;
                for (let dz = -1; dz <= 1; dz++) {
                    for (let dx = -1; dx <= 1; dx++) {
                        if (dx === 0 && dz === 0) continue;
                        const nx = x + dx, nz = z + dz;
                        if (nx >= 0 && nx < MINE_COLS && nz >= 0 && nz < MINE_ROWS) digBlock(nx, y, nz, splashDamage, false, false);
                    }
                }
            }
            updateUI({ fullRender: false });
        }

        function checkRowsCleared() {
            if (mineMeshes[0].every(mesh => mesh === null)) {
                state.depth++;
                mineGrid.shift(); mineMeshes.shift();
                const newY = state.depth + MINE_HEIGHT - 1;
                const newLayerData = [], newLayerMeshes = [];
                for (let z = 0; z < MINE_ROWS; z++) {
                    for (let x = 0; x < MINE_COLS; x++) {
                        const blockData = createBlockData(false, newY);
                        const mesh = createBlockMesh(x, MINE_HEIGHT - 1, z, blockData, newY);
                        newLayerData.push(blockData); newLayerMeshes.push(mesh); scene.add(mesh);
                    }
                }
                mineGrid.push(newLayerData); mineMeshes.push(newLayerMeshes);
                for(let y = 0; y < MINE_HEIGHT; y++) {
                    for(let i = 0; i < mineMeshes[y].length; i++) {
                        const mesh = mineMeshes[y][i];
                        if(mesh) { mesh.userData.gridY = y; mesh.userData.targetYPosition = -y * BLOCK_SIZE; }
                    }
                }
                autoMineTargetIndex = 0;
            }
        }
        
        function createHitParticles(position, color) {
            const particleCount = 5;
            const particleGeometry = new THREE.BoxGeometry(0.1, 0.1, 0.1);
            const particleMaterial = new THREE.MeshBasicMaterial({ color: color });
            for (let i = 0; i < particleCount; i++) {
                const particle = new THREE.Mesh(particleGeometry, particleMaterial);
                particle.position.copy(position);
                particle.velocity = new THREE.Vector3((Math.random() - 0.5) * 2, (Math.random() - 0.5) * 2, (Math.random() - 0.5) * 2);
                particle.lifetime = Math.random() * 0.5 + 0.3;
                particles.push(particle); scene.add(particle);
            }
        }
        
        function addMiner() {
            const minerGroup = new THREE.Group();
            minerGroup.add(new THREE.Mesh(new THREE.CylinderGeometry(0.25, 0.25, 0.6, 8), new THREE.MeshStandardMaterial({ color: 0x475569 })));
            const head = new THREE.Mesh(new THREE.SphereGeometry(0.2, 16, 16), new THREE.MeshStandardMaterial({ color: 0xf59e0b }));
            head.position.y = 0.5; minerGroup.add(head);
            const light = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 0.02, 8), new THREE.MeshBasicMaterial({ color: 0xffff00 }));
            light.position.set(0, 0.6, 0.2); light.rotation.x = Math.PI / 2; minerGroup.add(light);
            const startX = Math.floor(Math.random() * MINE_COLS), startZ = Math.floor(Math.random() * MINE_ROWS);
            minerGroup.position.set(startX, 0.5, startZ);
            scene.add(minerGroup);
            visualMiners.push({ mesh: minerGroup, state: 'IDLE', target: null, digTimer: 0, restTimer: 0 });
        }

        // --- UI & Rendering ---
        function showNotification(message, type = 'info') {
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.textContent = message;
            notificationContainer.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        function updateUI(options = {}) {
            const fullRender = options.fullRender === undefined ? true : options.fullRender;
            moneyEl.textContent = `${formatMoney(state.resources.money)} $`;
            const currentPanel = document.querySelector('#panel-container .panel');
            if (!currentPanel) return;

            if (fullRender && activePanel) {
                switch(activePanel) {
                    case 'template-gacha': renderGachaPanel(); break;
                    case 'template-heroes': renderHeroesPanel(); break;
                    case 'template-artifacts': renderArtifactsPanel(); break;
                    case 'template-equipment': renderEquipmentPanel(); break;
                    case 'template-dungeon': renderDungeonPanel(); break;
                    case 'template-stats': renderStatsPanel(); break;
                    case 'template-music': renderMusicPanel(); break;
                }
            }
            
            if (activePanel === 'template-upgrades') {
                const agentContainer = currentPanel.querySelector('#agentTungContainer');
                if(agentContainer) {
                    if (!state.agents.tung.owned) {
                        agentContainer.innerHTML = `<button id="buyAgentTung" class="btn-primary">${formatMoney(50000)} $</button>`;
                    } else {
                        agentContainer.innerHTML = `
                            <button id="agentTungAction" class="btn-primary relative ${state.agents.tung.isTargeting ? '!bg-red-600' : ''}" ${state.agents.tung.cooldown > 0 ? 'disabled' : ''}>
                                ${state.agents.tung.isTargeting ? 'H·ªßy' : 'K√≠ch ho·∫°t'}
                                <div class="cooldown-overlay" style="opacity: ${state.agents.tung.cooldown > 0 ? 1 : 0};">
                                    <span>${Math.ceil(state.agents.tung.cooldown)}</span>
                                </div>
                            </button>`;
                    }
                }
                if (state.agents.tung.owned) {
                     const cooldownOverlay = currentPanel.querySelector('#agentTungContainer .cooldown-overlay');
                     if(cooldownOverlay) {
                         cooldownOverlay.style.opacity = state.agents.tung.cooldown > 0 ? '1' : '0';
                         cooldownOverlay.querySelector('span').textContent = Math.ceil(state.agents.tung.cooldown);
                         currentPanel.querySelector('#agentTungAction').disabled = state.agents.tung.cooldown > 0;
                     }
                }
                currentPanel.querySelector('#clickPowerStat').textContent = state.upgrades.clickPower;
                const clickCost = Math.ceil(15 * Math.pow(1.22, state.upgrades.clickPower - 1));
                currentPanel.querySelector('#upgradeClickCost').textContent = `${formatMoney(clickCost)} $`;
                currentPanel.querySelector('#upgradeClick').disabled = state.resources.money < clickCost;
                currentPanel.querySelector('#mineMultiLevelStat').textContent = state.upgrades.mineMultiLevel;
                const mineMultiCost = Math.ceil(450 * Math.pow(2.8, state.upgrades.mineMultiLevel));
                currentPanel.querySelector('#upgradeMineMultiCost').textContent = `${formatMoney(mineMultiCost)} $`;
                currentPanel.querySelector('#upgradeMineMulti').disabled = state.resources.money < mineMultiCost;
                currentPanel.querySelector('#autoMineLevelStat').textContent = state.upgrades.autoMineLevel;
                const autoMineCost = Math.ceil(80 * Math.pow(2.4, state.upgrades.autoMineLevel));
                currentPanel.querySelector('#upgradeAutoMineCost').textContent = `${formatMoney(autoMineCost)} $`;
                currentPanel.querySelector('#upgradeAutoMine').disabled = state.resources.money < autoMineCost;

                currentPanel.querySelector('#minerCountStat').textContent = `${state.upgrades.minerCount}/5`;
                const hireCost = Math.ceil(40 * Math.pow(1.55, state.upgrades.minerCount));
                const hireCostEl = currentPanel.querySelector('#hireMinerCost');
                if (state.upgrades.minerCount >= 5) {
                    hireCostEl.textContent = "Max"; currentPanel.querySelector('#hireMiner').disabled = true;
                } else {
                    hireCostEl.textContent = `${formatMoney(hireCost)} $`; currentPanel.querySelector('#hireMiner').disabled = state.resources.money < hireCost;
                }
                currentPanel.querySelector('#minerPowerLevelStat').textContent = state.upgrades.minerPowerLevel;
                const minerPowerCost = Math.ceil(150 * Math.pow(1.65, state.upgrades.minerPowerLevel - 1));
                currentPanel.querySelector('#upgradeMinerPowerCost').textContent = `${formatMoney(minerPowerCost)} $`;
                currentPanel.querySelector('#upgradeMinerPower').disabled = state.resources.money < minerPowerCost;

                currentPanel.querySelector('#superMinerLevelStat').textContent = `${state.upgrades.superMinerLevel}/5`;
                const superMinerCost = Math.ceil(1800 * Math.pow(3.8, state.upgrades.superMinerLevel));
                const upgradeSuperMinerBtn = currentPanel.querySelector('#upgradeSuperMiner');
                const superMinerCostEl = currentPanel.querySelector('#upgradeSuperMinerCost');
                 if (state.upgrades.superMinerLevel >= 5) {
                    superMinerCostEl.textContent = "Max"; upgradeSuperMinerBtn.disabled = true;
                } else {
                    superMinerCostEl.textContent = `${formatMoney(superMinerCost)} $`; upgradeSuperMinerBtn.disabled = state.resources.money < superMinerCost;
                }
                currentPanel.querySelector('#minerStaminaLevelStat').textContent = state.upgrades.minerStaminaLevel;
                const minerStaminaCost = Math.ceil(250 * Math.pow(1.9, state.upgrades.minerStaminaLevel));
                currentPanel.querySelector('#upgradeMinerStaminaCost').textContent = `${formatMoney(minerStaminaCost)} $`;
                currentPanel.querySelector('#upgradeMinerStamina').disabled = state.resources.money < minerStaminaCost;
            }
        }
        
        function renderGachaPanel() {
            const panel = panelContainer.querySelector('.panel');
            if (!panel) return;
            const bannerListEl = panel.querySelector('#gacha-banner-list');
            bannerListEl.innerHTML = '';
            for (const bannerId in GACHA_BANNERS) {
                const banner = GACHA_BANNERS[bannerId];
                const button = document.createElement('button');
                button.className = `banner-list-item ${bannerId === state.activeBanner ? 'active' : ''}`;
                button.dataset.banner = bannerId;
                button.textContent = banner.name;
                bannerListEl.appendChild(button);
            }
            if (state.activeBanner) renderGachaBannerDetails(state.activeBanner);
            else panel.querySelector('#gacha-banner-content').innerHTML = `<p class="text-slate-400 text-center">Ch·ªçn m·ªôt banner ƒë·ªÉ xem chi ti·∫øt.</p>`;
        }

        function renderGachaBannerDetails(bannerId) {
            const banner = GACHA_BANNERS[bannerId];
            const panel = panelContainer.querySelector('.panel');
            if (!panel || !banner) return;
            const contentEl = panel.querySelector('#gacha-banner-content');
            
            let tooltipContent = '<h3>Nh√¢n v·∫≠t trong Banner</h3>';
            ['Mythic', 'Legend', 'Epic', 'Rare', 'Common'].forEach(rarity => {
                if (banner.pool[rarity] && banner.pool[rarity].length > 0) {
                    const heroNames = banner.pool[rarity].map(id => HERO_DATA[id].name).join(', ');
                    tooltipContent += `<p><strong class="rarity-${rarity}">${rarity}:</strong> ${heroNames}</p>`;
                }
            });

            contentEl.innerHTML = `
                <div class="flex items-center justify-between border-b border-slate-600 pb-1 mb-2">
                    <h2 class="font-bold text-lg">${banner.name}</h2>
                    <div class="info-icon" title="Th√¥ng tin nh√¢n v·∫≠t">i<div class="banner-tooltip">${tooltipContent}</div></div>
                </div>
                <p class="text-sm text-slate-400 mb-2">Pity Mythical sau: <span class="font-bold text-amber-400">${state.stats.pityCounters[bannerId]}</span> l∆∞·ª£t.</p>
                <div class="flex gap-2">
                    <button id="summon-1" class="btn-primary text-lg">x1 (${formatMoney(banner.cost)}$)</button>
                    <button id="summon-3" class="btn-primary text-lg">x3 (${formatMoney(banner.cost * 3)}$)</button>
                    <button id="summon-5" class="btn-primary text-lg">x5 (${formatMoney(banner.cost * 5)}$)</button>
                </div>`;
        }
        
        function renderHeroesPanel() {
            const panel = panelContainer.querySelector('.panel');
            if (!panel) return;
            panel.querySelector('#equipped-count').textContent = state.heroes.equipped.length;
            const heroCollectionEl = panel.querySelector('#hero-collection');
            if (state.heroes.collection.length === 0) {
                heroCollectionEl.innerHTML = `<p class="text-slate-400 text-center">Ch∆∞a c√≥ hero n√†o. H√£y quay th∆∞·ªüng!</p>`;
            } else {
                heroCollectionEl.innerHTML = '';
                state.heroes.collection.forEach(heroId => {
                    const hero = HERO_DATA[heroId];
                    if (!hero) return;
                    const isEquipped = state.heroes.equipped.includes(heroId);
                    const card = document.createElement('div');
                    card.className = `hero-card ${isEquipped ? 'equipped' : ''}`;
                    card.innerHTML = `
                        <img src="${hero.image}" class="w-12 h-12 object-cover rounded" onerror="this.onerror=null;this.src='https://placehold.co/48x48/1e293b/94a3b8?text=Err';">
                        <div class="flex-1">
                            <p class="font-bold">${hero.name} <span class="text-sm font-normal rarity-${hero.rarity}">(${hero.rarity})</span></p>
                            <p class="text-sm text-slate-400">${hero.bonusText}</p>
                        </div>
                        <button class="btn-primary !w-auto px-3" data-hero-id="${heroId}">${isEquipped ? 'G·ª°' : 'Trang b·ªã'}</button>`;
                    heroCollectionEl.appendChild(card);
                });
            }
        }

        function renderArtifactsPanel() {
            const panel = panelContainer.querySelector('.panel');
            if (!panel) return;
            panel.querySelector('#equipped-artifact-count').textContent = state.artifacts.equipped.length;
            const artifactCollectionEl = panel.querySelector('#artifact-collection');
            if (state.artifacts.collection.length === 0) {
                artifactCollectionEl.innerHTML = `<p class="text-slate-400 text-center">Ch∆∞a c√≥ di v·∫≠t n√†o. H√£y chinh ph·ª•c Dungeon!</p>`;
            } else {
                artifactCollectionEl.innerHTML = '';
                state.artifacts.collection.forEach(artifactId => {
                    const artifact = ARTIFACT_DATA[artifactId];
                    if (!artifact) return;
                    const isEquipped = state.artifacts.equipped.includes(artifactId);
                    const card = document.createElement('div');
                    card.className = `artifact-card ${isEquipped ? 'equipped' : ''}`;
                    card.innerHTML = `
                        <img src="${artifact.image}" class="w-12 h-12 object-contain bg-slate-900/50 p-1 rounded" onerror="this.onerror=null;this.src='https://placehold.co/48x48/1e293b/94a3b8?text=Err';">
                        <div class="flex-1">
                            <p class="font-bold">${artifact.name} <span class="text-sm font-normal rarity-${artifact.rarity}">(${artifact.rarity})</span></p>
                            <p class="text-sm text-slate-400">${artifact.bonusText}</p>
                        </div>
                        <button class="btn-primary !w-auto px-3" data-artifact-id="${artifactId}">${isEquipped ? 'G·ª°' : 'Trang b·ªã'}</button>`;
                    artifactCollectionEl.appendChild(card);
                });
            }
        }

        function renderDungeonPanel() {
            const panel = panelContainer.querySelector('.panel');
            if (!panel) return;
            panel.querySelector('#dungeon-highest-floor').textContent = state.dungeon.highestFloor;
        }
        
        function renderStatsPanel() {
            const panel = panelContainer.querySelector('.panel');
            if (!panel) return;
            panel.querySelector('#depthStat').textContent = state.depth;
            const hours = Math.floor(state.stats.timePlayed / 3600).toString().padStart(2, '0');
            const minutes = Math.floor((state.stats.timePlayed % 3600) / 60).toString().padStart(2, '0');
            const seconds = Math.floor(state.stats.timePlayed % 60).toString().padStart(2, '0');
            panel.querySelector('#timePlayed').textContent = `${hours}:${minutes}:${seconds}`;
            panel.querySelector('#blocksMined').textContent = state.stats.blocksMined;
            panel.querySelector('#moneyEarned').textContent = `${formatMoney(state.stats.moneyEarned)} $`;
            panel.querySelector('#moneySpent').textContent = `${formatMoney(state.stats.moneySpent)} $`;
            let totalFlatBonus = 0, totalMultiplier = 1;
            state.heroes.equipped.forEach(heroId => {
                const hero = HERO_DATA[heroId];
                if (hero) {
                    if (hero.bonusType === 'flat') totalFlatBonus += hero.bonusValue;
                    else if (hero.bonusType === 'multiplier') totalMultiplier *= hero.bonusValue;
                }
            });
            panel.querySelector('#heroFlatBonusStat').textContent = `+${totalFlatBonus} $`;
            panel.querySelector('#heroMultiplierStat').textContent = `x${totalMultiplier.toFixed(2)}`;
            panel.querySelector('#playerDamageStat').textContent = calculatePlayerDamage();
            const minedBlocksContainer = panel.querySelector('#mined-blocks-stats');
            const minedEntries = Object.entries(state.stats.minedBlockCounts);
            if (minedEntries.length === 0) minedBlocksContainer.innerHTML = `<p class="text-slate-400 text-center">Ch∆∞a c√≥ d·ªØ li·ªáu.</p>`;
            else {
                minedBlocksContainer.innerHTML = '';
                minedEntries.forEach(([blockId, count]) => {
                    const blockInfo = BLOCK_TYPES[blockId];
                    if (blockInfo) {
                        const statEl = document.createElement('div');
                        statEl.className = 'stat-item text-sm';
                        statEl.innerHTML = `<span>${blockInfo.name}:</span> <span class="font-bold">${count}</span>`;
                        minedBlocksContainer.appendChild(statEl);
                    }
                });
            }
        }

        function renderMusicPanel() {
            const panel = panelContainer.querySelector('.panel');
            if (!panel) return;
            
            // Update current track name
            const currentTrackName = panel.querySelector('#current-track-name');
            if (currentTrackName) {
                currentTrackName.textContent = state.music.tracks[state.music.currentTrack].name;
            }
            
            // Update play/pause button
            const playIcon = panel.querySelector('#play-icon');
            const pauseIcon = panel.querySelector('#pause-icon');
            if (playIcon && pauseIcon) {
                if (state.music.isPlaying) {
                    playIcon.style.display = 'none';
                    pauseIcon.style.display = 'block';
                } else {
                    playIcon.style.display = 'block';
                    pauseIcon.style.display = 'none';
                }
            }
            
            // Update volume display
            const volumeDisplay = panel.querySelector('#volume-display');
            if (volumeDisplay) {
                volumeDisplay.textContent = `${Math.round(state.music.volume * 100)}%`;
            }
            
            // Update volume slider
            const volumeSlider = panel.querySelector('#volume-slider');
            if (volumeSlider) {
                volumeSlider.value = state.music.volume * 100;
            }
            
            // Update track list
            const trackList = panel.querySelector('#track-list');
            if (trackList) {
                trackList.innerHTML = '';
                state.music.tracks.forEach((track, index) => {
                    const trackItem = document.createElement('div');
                    trackItem.className = `track-item ${index === state.music.currentTrack ? 'active' : ''}`;
                    trackItem.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span class="text-sm">${track.name}</span>
                            ${index === state.music.currentTrack ? '<span class="text-amber-400 text-xs">‚ñ∂</span>' : ''}
                        </div>
                    `;
                    trackItem.addEventListener('click', () => {
                        playTrack(index);
                    });
                    trackList.appendChild(trackItem);
                });
            }
        }

        function renderEquipmentPanel() {
            const panel = panelContainer.querySelector('.panel');
            if (!panel) return;
            
            // Update hero count
            const heroCountEl = panel.querySelector('#equipped-hero-count');
            if (heroCountEl) {
                heroCountEl.textContent = state.heroes.equipped.length;
            }
            
            // Update artifact count
            const artifactCountEl = panel.querySelector('#equipped-artifact-count');
            if (artifactCountEl) {
                artifactCountEl.textContent = state.artifacts.equipped.length;
            }
            
            // Render heroes
            const heroCollectionEl = panel.querySelector('#hero-collection');
            if (heroCollectionEl) {
                heroCollectionEl.innerHTML = '';
                
                if (state.heroes.collection.length === 0) {
                    heroCollectionEl.innerHTML = '<div class="col-span-2 text-center text-slate-400 text-sm py-4">Ch∆∞a c√≥ hero n√†o. H√£y quay gacha!</div>';
                } else {
                    state.heroes.collection.forEach(heroId => {
                        const hero = HERO_DATA[heroId];
                        if (hero) {
                            const isEquipped = state.heroes.equipped.includes(heroId);
                            const heroItem = document.createElement('div');
                            heroItem.className = `equipment-panel-item ${isEquipped ? 'equipped' : ''}`;
                            heroItem.dataset.heroId = heroId;
                            heroItem.innerHTML = `
                                <img src="${hero.image}" alt="${hero.name}" onerror="this.onerror=null;this.src='https://placehold.co/48x48/1e293b/94a3b8?text=?'">
                                <div class="item-name">${hero.name}</div>
                                <div class="item-rarity">${hero.rarity}</div>
                                <div class="item-bonus">${hero.bonusText}</div>
                            `;
                            heroCollectionEl.appendChild(heroItem);
                        }
                    });
                }
            }
            
            // Render artifacts
            const artifactCollectionEl = panel.querySelector('#artifact-collection');
            if (artifactCollectionEl) {
                artifactCollectionEl.innerHTML = '';
                
                if (state.artifacts.collection.length === 0) {
                    artifactCollectionEl.innerHTML = '<div class="col-span-2 text-center text-slate-400 text-sm py-4">Ch∆∞a c√≥ di v·∫≠t n√†o. H√£y chinh ph·ª•c Dungeon!</div>';
                } else {
                    state.artifacts.collection.forEach(artifactId => {
                        const artifact = ARTIFACT_DATA[artifactId];
                        if (artifact) {
                            const isEquipped = state.artifacts.equipped.includes(artifactId);
                            const artifactItem = document.createElement('div');
                            artifactItem.className = `equipment-panel-item ${isEquipped ? 'equipped' : ''}`;
                            artifactItem.dataset.artifactId = artifactId;
                            artifactItem.innerHTML = `
                                <img src="${artifact.image}" alt="${artifact.name}" onerror="this.onerror=null;this.src='https://placehold.co/48x48/1e293b/94a3b8?text=?'">
                                <div class="item-name">${artifact.name}</div>
                                <div class="item-rarity">${artifact.rarity}</div>
                                <div class="item-bonus">${artifact.bonusText}</div>
                            `;
                            artifactCollectionEl.appendChild(artifactItem);
                        }
                    });
                }
            }
        }

        function updateEquipmentPopup() {
            const equippedHeroesContainer = document.getElementById('equipped-heroes');
            const equippedArtifactsContainer = document.getElementById('equipped-artifacts');
            
            if (!equippedHeroesContainer || !equippedArtifactsContainer) return;
            
            // Update equipped heroes
            if (state.heroes.equipped.length === 0) {
                equippedHeroesContainer.innerHTML = '<div class="text-xs text-slate-500 italic">Ch∆∞a c√≥</div>';
            } else {
                equippedHeroesContainer.innerHTML = '';
                state.heroes.equipped.forEach(heroId => {
                    const hero = HERO_DATA[heroId];
                    if (hero) {
                        const heroItem = document.createElement('div');
                        heroItem.className = 'equipment-item';
                        heroItem.title = `${hero.name} (${hero.rarity})`;
                        heroItem.innerHTML = `
                            <img src="${hero.image}" alt="${hero.name}" onerror="this.onerror=null;this.src='https://placehold.co/16x16/1e293b/94a3b8?text=?'">
                            <span>${hero.name}</span>
                        `;
                        equippedHeroesContainer.appendChild(heroItem);
                    }
                });
            }
            
            // Update equipped artifacts
            if (state.artifacts.equipped.length === 0) {
                equippedArtifactsContainer.innerHTML = '<div class="text-xs text-slate-500 italic">Ch∆∞a c√≥</div>';
            } else {
                equippedArtifactsContainer.innerHTML = '';
                state.artifacts.equipped.forEach(artifactId => {
                    const artifact = ARTIFACT_DATA[artifactId];
                    if (artifact) {
                        const artifactItem = document.createElement('div');
                        artifactItem.className = 'equipment-item';
                        artifactItem.title = `${artifact.name} - ${artifact.bonusText}`;
                        artifactItem.innerHTML = `
                            <img src="${artifact.image}" alt="${artifact.name}" onerror="this.onerror=null;this.src='https://placehold.co/16x16/1e293b/94a3b8?text=?'">
                            <span>${artifact.name}</span>
                        `;
                        equippedArtifactsContainer.appendChild(artifactItem);
                    }
                });
            }
        }

        // --- Event Handlers ---
        function onWindowResize() {
            const aspect = window.innerWidth / window.innerHeight;
            const viewSize = MINE_COLS * 2.0;
            const halfViewSize = viewSize / 2;
            camera.left = -halfViewSize * aspect; camera.right = halfViewSize * aspect;
            camera.top = halfViewSize; camera.bottom = -halfViewSize;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function onCanvasClick(event) {
            const rect = canvas.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / canvas.clientWidth) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / canvas.clientHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(mineMeshes.flat().filter(m => m));
            if (intersects.length > 0) {
                const first = intersects[0].object;
                if (state.agents.tung.isTargeting) {
                     if (first.userData && first.userData.gridX !== undefined) {
                        const { gridX, gridY, gridZ } = first.userData;
                        digBlock(gridX, gridY, gridZ, Infinity, false, false);
                        state.agents.tung.cooldown = 60;
                        cancelAgentTungTargeting();
                    }
                } else if (first.userData && first.userData.gridX !== undefined) {
                    const { gridX, gridY, gridZ } = first.userData;
                    digBlock(gridX, gridY, gridZ, state.upgrades.clickPower, true, false);
                }
            }
        }
        
        function setupPanelToggle(buttonId, templateId) {
            const button = document.getElementById(buttonId);
            button.addEventListener('click', () => {
                if (activePanel === templateId) {
                    panelContainer.innerHTML = ''; activePanel = null;
                    Object.values(toggleButtons).forEach(b => b.classList.remove('active'));
                    cancelAgentTungTargeting();
                } else {
                    const template = document.getElementById(templateId);
                    panelContainer.innerHTML = '';
                    panelContainer.appendChild(template.content.cloneNode(true));
                    activePanel = templateId;
                    Object.values(toggleButtons).forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                    updateUI({ fullRender: true });
                }
            });
        }

        // --- Music Functions ---
        function initMusicPlayer() {
            audioPlayer = new Audio();
            audioPlayer.loop = true;
            audioPlayer.volume = state.music.volume;
            
            // Set up event listeners for audio
            audioPlayer.addEventListener('ended', () => {
                nextTrack();
            });
            
            // Load first track
            loadTrack(state.music.currentTrack);
        }
        
        function loadTrack(trackIndex) {
            if (trackIndex < 0 || trackIndex >= state.music.tracks.length) return;
            
            const track = state.music.tracks[trackIndex];
            audioPlayer.src = track.file;
            state.music.currentTrack = trackIndex;
            
            if (activePanel === 'template-music') {
                renderMusicPanel();
            }
        }
        
        function playTrack(trackIndex) {
            if (trackIndex !== undefined) {
                loadTrack(trackIndex);
            }
            
            if (audioPlayer) {
                audioPlayer.play().then(() => {
                    state.music.isPlaying = true;
                    if (activePanel === 'template-music') {
                        renderMusicPanel();
                    }
                }).catch(error => {
                    console.log('Audio play failed:', error);
                });
            }
        }
        
        function pauseTrack() {
            if (audioPlayer) {
                audioPlayer.pause();
                state.music.isPlaying = false;
                if (activePanel === 'template-music') {
                    renderMusicPanel();
                }
            }
        }
        
        function nextTrack() {
            const nextIndex = (state.music.currentTrack + 1) % state.music.tracks.length;
            loadTrack(nextIndex);
            if (state.music.isPlaying) {
                playTrack();
            }
        }
        
        function prevTrack() {
            const prevIndex = state.music.currentTrack === 0 ? state.music.tracks.length - 1 : state.music.currentTrack - 1;
            loadTrack(prevIndex);
            if (state.music.isPlaying) {
                playTrack();
            }
        }
        
        function setVolume(volume) {
            state.music.volume = volume;
            if (audioPlayer) {
                audioPlayer.volume = volume;
            }
            if (activePanel === 'template-music') {
                renderMusicPanel();
            }
        }

        function setupEventListeners() {
            panelContainer.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) {
                    if (e.target.closest('[data-banner]')) {
                        state.activeBanner = e.target.closest('[data-banner]').dataset.banner;
                        renderGachaBannerDetails(state.activeBanner);
                    }
                    return;
                }

                const { id, dataset } = button;
                if (dataset.banner) { state.activeBanner = dataset.banner; renderGachaBannerDetails(state.activeBanner); return; }
                if (dataset.tab) {
                    panelContainer.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                    panelContainer.querySelector(`#${dataset.tab}`).classList.remove('hidden');
                    panelContainer.querySelectorAll('.tab-button').forEach(tab => tab.classList.remove('active'));
                    button.classList.add('active');
                    return;
                }
                if (dataset.heroId) { toggleEquipHero(dataset.heroId); return; }
                if (dataset.artifactId) { toggleEquipArtifact(dataset.artifactId); return; }

                switch(id) {
                    case 'buyAgentTung': {
                        const cost = 50000;
                        if (state.resources.money >= cost) { state.resources.money -= cost; state.stats.moneySpent += cost; state.agents.tung.owned = true; updateUI({ fullRender: true }); }
                        break;
                    }
                    case 'agentTungAction': state.agents.tung.isTargeting ? cancelAgentTungTargeting() : activateAgentTungTargeting(); break;
                    case 'upgradeClick': {
                        const cost = Math.ceil(15 * Math.pow(1.22, state.upgrades.clickPower - 1));
                        if (state.resources.money >= cost) { state.resources.money -= cost; state.stats.moneySpent += cost; state.upgrades.clickPower++; updateUI({ fullRender: true }); }
                        break;
                    }
                    case 'upgradeMineMulti': {
                        const cost = Math.ceil(450 * Math.pow(2.8, state.upgrades.mineMultiLevel));
                        if(state.resources.money >= cost) { state.resources.money -= cost; state.stats.moneySpent += cost; state.upgrades.mineMultiLevel++; updateUI({ fullRender: true }); }
                        break;
                    }
                    case 'upgradeAutoMine': {
                        const cost = Math.ceil(80 * Math.pow(2.4, state.upgrades.autoMineLevel));
                        if(state.resources.money >= cost) { state.resources.money -= cost; state.stats.moneySpent += cost; state.upgrades.autoMineLevel++; updateUI({ fullRender: true }); }
                        break;
                    }
                    case 'hireMiner': {
                        if (state.upgrades.minerCount < 5) {
                            const cost = Math.ceil(40 * Math.pow(1.55, state.upgrades.minerCount));
                            if (state.resources.money >= cost) { state.resources.money -= cost; state.stats.moneySpent += cost; state.upgrades.minerCount++; addMiner(); updateUI({ fullRender: true }); }
                        }
                        break;
                    }
                    case 'upgradeMinerPower': {
                        const cost = Math.ceil(150 * Math.pow(1.65, state.upgrades.minerPowerLevel - 1));
                        if (state.resources.money >= cost) { state.resources.money -= cost; state.stats.moneySpent += cost; state.upgrades.minerPowerLevel++; updateUI({ fullRender: true }); }
                        break;
                    }
                    case 'upgradeSuperMiner': {
                         if (state.upgrades.superMinerLevel < 5) {
                            const cost = Math.ceil(1800 * Math.pow(3.8, state.upgrades.superMinerLevel));
                            if (state.resources.money >= cost) { state.resources.money -= cost; state.stats.moneySpent += cost; state.upgrades.superMinerLevel++; updateUI({ fullRender: true }); }
                        }
                        break;
                    }
                    case 'upgradeMinerStamina': {
                        const cost = Math.ceil(250 * Math.pow(1.9, state.upgrades.minerStaminaLevel));
                        if (state.resources.money >= cost) { state.resources.money -= cost; state.stats.moneySpent += cost; state.upgrades.minerStaminaLevel++; updateUI({ fullRender: true }); }
                        break;
                    }
                    case 'giftcode-submit': redeemGiftcode(); break;
                    case 'summon-1': summonHero(1, state.activeBanner); break;
                    case 'summon-3': summonHero(3, state.activeBanner); break;
                    case 'summon-5': summonHero(5, state.activeBanner); break;
                    case 'start-dungeon-btn': startDungeonRun(); break;
                    case 'music-play-pause': 
                        if (state.music.isPlaying) {
                            pauseTrack();
                        } else {
                            playTrack();
                        }
                        break;
                    case 'music-next': nextTrack(); break;
                    case 'music-prev': prevTrack(); break;
                }
            });
            
            // Music volume slider event listener
            panelContainer.addEventListener('input', (e) => {
                if (e.target.id === 'volume-slider') {
                    const volume = parseFloat(e.target.value) / 100;
                    setVolume(volume);
                }
            });
            
            // Equipment panel click listeners
            panelContainer.addEventListener('click', (e) => {
                const heroItem = e.target.closest('[data-hero-id]');
                const artifactItem = e.target.closest('[data-artifact-id]');
                
                if (heroItem) {
                    const heroId = heroItem.dataset.heroId;
                    toggleEquipHero(heroId);
                }
                
                if (artifactItem) {
                    const artifactId = artifactItem.dataset.artifactId;
                    toggleEquipArtifact(artifactId);
                }
            });
        }
        
        function activateAgentTungTargeting() {
            if (state.agents.tung.cooldown > 0) return;
            state.agents.tung.isTargeting = true;
            canvas.style.cursor = 'crosshair';
            showNotification("Ch·ªçn m·ªôt kh·ªëi ƒë·ªÉ ph√° h·ªßy");
            updateUI({ fullRender: true });
        }

        function cancelAgentTungTargeting() {
            if (!state.agents.tung.isTargeting) return;
            state.agents.tung.isTargeting = false;
            canvas.style.cursor = 'pointer';
            updateUI({ fullRender: true });
        }
        
        function redeemGiftcode() {
            const input = panelContainer.querySelector('#giftcode-input');
            const messageEl = panelContainer.querySelector('#giftcode-message');
            if(!input || !messageEl) return;
            const code = input.value.toLowerCase().trim();
            if (code === 'phophuc') {
                if (state.usedCodes.includes(code)) {
                    messageEl.textContent = "Code ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng!";
                } else {
                    state.resources.money += 25000000;
                    state.stats.moneyEarned += 25000000;
                    state.usedCodes.push(code);
                    messageEl.textContent = `B·∫°n nh·∫≠n ƒë∆∞·ª£c ${formatMoney(25000000)}$!`;
                    updateUI({ fullRender: true });
                }
            } else {
                messageEl.textContent = "Code kh√¥ng h·ª£p l·ªá!";
            }
            input.value = '';
            setTimeout(() => { if(messageEl) messageEl.textContent = ''; }, 3000);
        }

        // --- Gacha, Hero & Artifact Logic ---
        function summonHero(count = 1, bannerId) {
            if (isGachaAnimating) return; 
            if (!bannerId) { showNotification("Vui l√≤ng ch·ªçn m·ªôt banner!", "error"); return; }
            const banner = GACHA_BANNERS[bannerId];
            if (!banner) return;
            const cost = banner.cost * count;
            if (state.resources.money < cost) { showNotification("Kh√¥ng ƒë·ªß ti·ªÅn!", "error"); return; };

            isGachaAnimating = true;
            state.resources.money -= cost; state.stats.moneySpent += cost;
            let results = [], totalRefund = 0;
            for(let i = 0; i < count; i++) {
                let chosenRarity;
                if (state.stats.pityCounters[bannerId] <= count - i) {
                    chosenRarity = 'Mythic'; state.stats.pityCounters[bannerId] = 80;
                } else {
                    const rand = Math.random(); let cumulativeRate = 0;
                    for (const rarity in banner.rates) {
                        cumulativeRate += banner.rates[rarity];
                        if (rand < cumulativeRate) { chosenRarity = rarity; break; }
                    }
                    state.stats.pityCounters[bannerId]--;
                }
                const pool = banner.pool[chosenRarity];
                const heroId = pool[Math.floor(Math.random() * pool.length)];
                if (state.heroes.collection.includes(heroId)) totalRefund += Math.floor(banner.cost * banner.refundRate);
                else state.heroes.collection.push(heroId);
                results.push(HERO_DATA[heroId]);
            }
            state.resources.money += totalRefund;
            showGachaResult(results, totalRefund, bannerId);
            updateUI({ fullRender: true });
        }

        function showGachaResult(results, totalRefund, bannerId) {
            const modal = document.getElementById('gacha-modal');
            const container = document.getElementById('gacha-result-container');
            container.innerHTML = `<div class="gacha-reels-container"></div><div id="gacha-final-result"></div><p class="text-sm text-slate-500 mt-4 opacity-0" id="gacha-close-message">(Nh·∫•p v√†o n√∫t ƒê√≥ng ho·∫∑c Quay ti·∫øp)</p>`;
            modal.classList.add('show');
            const reelsContainer = container.querySelector('.gacha-reels-container');
            const banner = GACHA_BANNERS[bannerId];
            const animationHeroes = Object.values(banner.pool).flat().map(heroId => HERO_DATA[heroId]).filter(hero => hero.rarity !== 'Secret');
            const reelHeight = 140, spinItemsCount = 30;
            let longestDuration = 0;
            results.forEach((result, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'gacha-reel-wrapper';
                wrapper.dataset.heroId = result.id;
                const reel = document.createElement('div');
                reel.className = 'gacha-reel';
                for(let i = 0; i < spinItemsCount; i++) {
                    const randomHero = animationHeroes[Math.floor(Math.random() * animationHeroes.length)];
                    reel.innerHTML += `<img src="${randomHero.image}" alt="${randomHero.name}" onerror="this.onerror=null;this.src='https://placehold.co/140x140/1e293b/94a3b8?text=Error';">`;
                }
                reel.innerHTML += `<img src="${result.image}" alt="${result.name}" onerror="this.onerror=null;this.src='https://placehold.co/140x140/1e293b/94a3b8?text=Error';">`;
                wrapper.appendChild(reel);
                reelsContainer.appendChild(wrapper);
                const duration = 2.5 + index * 0.4;
                if (duration > longestDuration) longestDuration = duration;
                requestAnimationFrame(() => {
                    reel.style.transition = `transform ${duration}s cubic-bezier(0.25, 1, 0.5, 1)`;
                    reel.style.transform = `translateY(-${spinItemsCount * reelHeight}px)`;
                });
            });

            setTimeout(() => {
                if (totalRefund > 0) showNotification(`ƒê∆∞·ª£c ho√†n ${formatMoney(totalRefund)}$ t·ª´ nh√¢n v·∫≠t tr√πng l·∫∑p!`, 'info');
                const finalResultContainer = document.getElementById('gacha-final-result');
                const bestHero = [...results].sort((a, b) => ({ Secret: 5, Mythic: 4, Legend: 3, Epic: 2, Rare: 1, Common: 0 })[b.rarity] - ({ Secret: 5, Mythic: 4, Legend: 3, Epic: 2, Rare: 1, Common: 0 })[a.rarity])[0];
                reelsContainer.querySelectorAll('.gacha-reel-wrapper').forEach(reel => {
                    if (reel.dataset.heroId === bestHero.id) reel.classList.add(`highlight-${bestHero.rarity}`);
                });
                finalResultContainer.innerHTML = `
                    <div class="final-hero-display">
                        <img src="${bestHero.image}" alt="${bestHero.name}" class="hero-image object-cover" onerror="this.onerror=null;this.src='https://placehold.co/120x120/1e293b/94a3b8?text=Error';">
                        <div>
                            <p class="text-sm text-slate-400">B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c</p>
                            <h2 class="text-4xl font-bold rarity-${bestHero.rarity}">${bestHero.name}</h2>
                            <p class="font-semibold text-lg rarity-${bestHero.rarity}">(${bestHero.rarity})</p>
                        </div>
                        <div class="mt-4 flex flex-col sm:flex-row gap-2 w-full">
                            <button id="gacha-again-1" class="btn-primary text-base flex-1">Quay x1</button>
                            <button id="gacha-again-3" class="btn-primary text-base flex-1">Quay x3</button>
                            <button id="gacha-again-5" class="btn-primary text-base flex-1">Quay x5</button>
                        </div>
                         <button id="gacha-close" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg mt-2 w-full">ƒê√≥ng</button>
                    </div>`;
                finalResultContainer.classList.add('visible');
                document.getElementById('gacha-close-message').style.opacity = '1';
                isGachaAnimating = false;
            }, (longestDuration + 0.2) * 1000);
        }

        function toggleEquipHero(heroId) {
            const index = state.heroes.equipped.indexOf(heroId);
            if (index > -1) state.heroes.equipped.splice(index, 1);
            else {
                if (state.heroes.equipped.length < 3) state.heroes.equipped.push(heroId);
                else showNotification("B·∫°n ch·ªâ c√≥ th·ªÉ trang b·ªã t·ªëi ƒëa 3 hero!", "error");
            }
            updateUI({ fullRender: true });
            updateEquipmentPopup();
            if (activePanel === 'template-equipment') {
                renderEquipmentPanel();
            }
        }

        function toggleEquipArtifact(artifactId) {
            const index = state.artifacts.equipped.indexOf(artifactId);
            if (index > -1) {
                state.artifacts.equipped.splice(index, 1);
            } else {
                if (state.artifacts.equipped.length < 2) {
                    state.artifacts.equipped.push(artifactId);
                } else {
                    showNotification("B·∫°n ch·ªâ c√≥ th·ªÉ trang b·ªã t·ªëi ƒëa 2 di v·∫≠t!", "error");
                }
            }
            updateUI({ fullRender: true });
            updateEquipmentPopup();
            if (activePanel === 'template-equipment') {
                renderEquipmentPanel();
            }
        }
        
        // --- Dungeon Logic ---
        function calculatePlayerDamage() {
            let totalFlatBonus = 0;
            let totalMultiplier = 1;
            state.heroes.equipped.forEach(heroId => {
                const hero = HERO_DATA[heroId];
                if (hero) {
                    if (hero.bonusType === 'flat') {
                        totalFlatBonus += hero.bonusValue;
                    } else if (hero.bonusType === 'multiplier') {
                        totalMultiplier *= hero.bonusValue;
                    }
                }
            });

            let heroDamage = totalFlatBonus * totalMultiplier;
            
            let artifactDamage = 0;
            state.artifacts.equipped.forEach(artifactId => {
                const artifact = ARTIFACT_DATA[artifactId];
                if (artifact && artifact.bonusType === 'damage') {
                    artifactDamage += artifact.bonusValue;
                }
            });

            // Base damage of 1, plus hero damage, plus artifact damage.
            return 1 + heroDamage + artifactDamage;
        }

        function startDungeonRun() {
            if (dungeonTimerInterval) clearInterval(dungeonTimerInterval);
            
            state.dungeon.currentRun = {
                floor: 1,
                playerDamage: calculatePlayerDamage(),
                enemyHp: 300,
                maxEnemyHp: 300,
                timer: 10, // NEW: 10 seconds for normal floors
                lastCompletedPhase: 0,
                rewardsFromLastCompletedPhase: { money: 0, artifacts: [] },
                totalAccumulatedRewards: { money: 0, artifacts: [] }
            };

            renderDungeonCombatUI();
            document.getElementById('dungeon-combat-modal').classList.add('show');
            dungeonTimerInterval = setInterval(updateDungeonTimer, 1000);
        }

        function updateDungeonTimer() {
            const run = state.dungeon.currentRun;
            if (!run) {
                clearInterval(dungeonTimerInterval);
                return;
            }
            run.timer--;
            const timerEl = document.getElementById('dungeon-timer');
            if (timerEl) {
                timerEl.textContent = run.timer;
            }
            if (run.timer <= 0) {
                dungeonLose('H·∫øt gi·ªù!');
            }
        }

        function handleDungeonAttack() {
            const run = state.dungeon.currentRun;
            if (!run) return;
            
            run.enemyHp -= run.playerDamage;
            
            if (run.enemyHp <= 0) {
                dungeonWinFloor();
            } else {
                renderDungeonCombatUI();
            }
        }
        
        function dungeonWinFloor() {
            if (dungeonTimerInterval) clearInterval(dungeonTimerInterval);
            
            const run = state.dungeon.currentRun;
            if (!run) return;

            if (run.floor > state.dungeon.highestFloor) {
                state.dungeon.highestFloor = run.floor;
            }

            const isBossFloor = run.floor % 5 === 0;

            if (isBossFloor) {
                const currentPhase = run.floor / 5;
                
                let phaseMoneyReward = 100000;
                let phaseArtifactChance = 0.05;

                if (currentPhase > 1) {
                    let prevMoney = 100000;
                    let prevChance = 0.05;
                    for (let i = 2; i <= currentPhase; i++) {
                        prevMoney *= 1.20;
                        prevChance += 0.01;
                    }
                    phaseMoneyReward = Math.floor(prevMoney);
                    phaseArtifactChance = prevChance;
                }
                
                run.totalAccumulatedRewards.money += phaseMoneyReward;
                if (Math.random() < phaseArtifactChance) {
                     const artifactPool = Object.keys(ARTIFACT_DATA);
                     const wonArtifactId = artifactPool[Math.floor(Math.random() * artifactPool.length)];
                     run.totalAccumulatedRewards.artifacts.push(wonArtifactId);
                     showNotification(`B·∫°n t√¨m th·∫•y [${ARTIFACT_DATA[wonArtifactId].name}]!`, 'success');
                }

                run.rewardsFromLastCompletedPhase = { ...run.totalAccumulatedRewards, artifacts: [...run.totalAccumulatedRewards.artifacts] };
                run.lastCompletedPhase = currentPhase;

                if (currentPhase > 0 && currentPhase % 25 === 0) {
                    showNotification(`ƒê·∫°t m·ªëc ${currentPhase} phase! T·ª± ƒë·ªông nh·∫≠n th∆∞·ªüng v√† ti·∫øp t·ª•c.`, 'success');
                    claimDungeonRewards(true); // true = continue run
                } else {
                    renderPhaseClearUI();
                }

            } else {
                goToNextFloor();
            }
        }
        
        function goToNextFloor() {
            const run = state.dungeon.currentRun;
            if (!run) return;

            run.floor++;
            const isBoss = run.floor % 5 === 0;

            let newMaxHp = 300;
            for (let i = 2; i <= run.floor; i++) {
                if (i % 5 === 0) {
                    newMaxHp *= 1.30;
                } else {
                    newMaxHp *= 1.07;
                }
            }
            run.maxEnemyHp = Math.floor(newMaxHp);
            run.enemyHp = run.maxEnemyHp;
            
            run.timer = isBoss ? 15 : 10; // NEW: 15s for boss, 10s for normal

            renderDungeonCombatUI();
            if (dungeonTimerInterval) clearInterval(dungeonTimerInterval);
            dungeonTimerInterval = setInterval(updateDungeonTimer, 1000);
        }

        function dungeonLose(reason) {
            if (dungeonTimerInterval) clearInterval(dungeonTimerInterval);
            dungeonTimerInterval = null;
            
            const run = state.dungeon.currentRun;
            if (!run) return;

            const rewards = run.rewardsFromLastCompletedPhase;
            let rewardMessage = `B·∫°n ƒë√£ thua ·ªü t·∫ßng ${run.floor}. (${reason})`;

            if (rewards.money > 0 || rewards.artifacts.length > 0) {
                state.resources.money += rewards.money;
                state.stats.moneyEarned += rewards.money;
                
                let newArtifactsCount = 0;
                rewards.artifacts.forEach(artifactId => {
                    if (!state.artifacts.collection.includes(artifactId)) {
                        state.artifacts.collection.push(artifactId);
                        newArtifactsCount++;
                    }
                });
                rewardMessage += `\nB·∫°n nh·∫≠n ƒë∆∞·ª£c ph·∫ßn th∆∞·ªüng t·ª´ phase ${run.lastCompletedPhase}: ${formatMoney(rewards.money)}$ v√† ${newArtifactsCount > 0 ? `${rewards.artifacts.length} di v·∫≠t` : '0 di v·∫≠t'}.`;
                showNotification(rewardMessage, 'info');
            } else {
                showNotification(rewardMessage + "\nKh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫ßn th∆∞·ªüng.", 'error');
            }
            
            endDungeonRun();
        }

        function claimDungeonRewards(continueRun = false) {
            if (dungeonTimerInterval) clearInterval(dungeonTimerInterval);
            dungeonTimerInterval = null;

            const run = state.dungeon.currentRun;
            if (!run || !run.totalAccumulatedRewards) return;

            const rewards = run.totalAccumulatedRewards;
            
            if (rewards.money > 0 || rewards.artifacts.length > 0) {
                state.resources.money += rewards.money;
                state.stats.moneyEarned += rewards.money;
                
                let newArtifactsCount = 0;
                rewards.artifacts.forEach(artifactId => {
                    if (!state.artifacts.collection.includes(artifactId)) {
                        state.artifacts.collection.push(artifactId);
                        newArtifactsCount++;
                    }
                });

                let rewardMessage = `B·∫°n nh·∫≠n ƒë∆∞·ª£c ${formatMoney(rewards.money)}$ v√† ${newArtifactsCount > 0 ? `${rewards.artifacts.length} di v·∫≠t` : '0 di v·∫≠t'}.`;
                showNotification(rewardMessage, 'success');
            } else {
                showNotification("Kh√¥ng c√≥ ph·∫ßn th∆∞·ªüng n√†o ƒë·ªÉ nh·∫≠n.", 'info');
            }
            
            if (continueRun) {
                run.totalAccumulatedRewards = { money: 0, artifacts: [] };
                run.rewardsFromLastCompletedPhase = { money: 0, artifacts: [] };
                goToNextFloor();
            } else {
                endDungeonRun();
            }
        }

        function endDungeonRun() {
            if (dungeonTimerInterval) clearInterval(dungeonTimerInterval);
            dungeonTimerInterval = null;
            
            state.dungeon.currentRun = null;
            document.getElementById('dungeon-combat-modal').classList.remove('show');
            
            if (activePanel === 'template-dungeon') renderDungeonPanel();
            if (activePanel === 'template-stats') renderStatsPanel();
            if (activePanel === 'template-artifacts') renderArtifactsPanel();
            if (activePanel === 'template-music') renderMusicPanel();
            
            // Update equipment popup
            updateEquipmentPopup();
        }
        
        function renderDungeonCombatUI() {
            const container = document.getElementById('dungeon-combat-container');
            const run = state.dungeon.currentRun;
            if (!run) return;

            const isBoss = run.floor % 5 === 0;
            const hpPercent = (run.enemyHp / run.maxEnemyHp) * 100;

            let enemyName, enemyImgSrc;

            if (isBoss) {
                const phase = run.floor / 5;
                const bossIndex = (phase - 1) % DUNGEON_BOSSES.length;
                const boss = DUNGEON_BOSSES[bossIndex];
                enemyName = `BOSS: ${boss.name}`;
                enemyImgSrc = boss.image;
            } else {
                enemyName = `Qu√°i V·∫≠t T·∫ßng ${run.floor}`;
                enemyImgSrc = DUNGEON_MINIONS[(run.floor - 1) % DUNGEON_MINIONS.length];
            }

            container.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-3xl font-bold text-red-500">Dungeon - T·∫ßng ${run.floor}</h2>
                    <div class="text-4xl font-bold text-yellow-400">
                        <span id="dungeon-timer">${run.timer}</span>s
                    </div>
                </div>
                <img id="dungeon-enemy-img" src="${enemyImgSrc}" alt="Dungeon Enemy" onerror="this.onerror=null;this.src='https://placehold.co/200x200/0f172a/e2e8f0?text=Error';">
                <p class="font-bold text-xl mb-2">${enemyName}</p>
                <div class="hp-bar mb-1">
                    <div id="dungeon-hp-bar-inner" class="hp-bar-inner" style="width: ${hpPercent}%;"></div>
                </div>
                <p id="dungeon-hp-text" class="font-mono text-lg">${formatMoney(run.enemyHp)} / ${formatMoney(run.maxEnemyHp)} HP</p>
                <div class="flex gap-4 mt-6">
                    <button id="dungeon-attack-btn" class="btn-primary !w-auto flex-grow">T·∫•n C√¥ng</button>
                    <button id="dungeon-leave-btn" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg !w-auto">R·ªùi ƒëi</button>
                </div>
            `;
        }
        
        function renderPhaseClearUI() {
            const container = document.getElementById('dungeon-combat-container');
            const run = state.dungeon.currentRun;
            if (!run) return;

            container.innerHTML = `
                <h2 class="text-3xl font-bold text-amber-400 mb-4">Ho√†n th√†nh Phase ${run.lastCompletedPhase}!</h2>
                <p class="text-lg mb-2">Ph·∫ßn th∆∞·ªüng t√≠ch l≈©y hi·ªán t·∫°i:</p>
                <p class="text-2xl font-bold text-green-400 mb-1">${formatMoney(run.totalAccumulatedRewards.money)}$</p>
                <p class="text-xl font-bold text-cyan-400 mb-6">${run.totalAccumulatedRewards.artifacts.length} Di v·∫≠t</p>
                
                <p class="mb-4">B·∫°n mu·ªën ti·∫øp t·ª•c kh√°m ph√° hay d·ª´ng l·∫°i v√† nh·∫≠n th∆∞·ªüng?</p>

                <div class="flex gap-4 mt-6">
                    <button id="dungeon-continue-btn" class="btn-primary !w-auto flex-grow">Ti·∫øp t·ª•c</button>
                    <button id="dungeon-claim-btn" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg !w-auto">D·ª´ng l·∫°i & Nh·∫≠n th∆∞·ªüng</button>
                </div>
            `;
        }

        // --- Game Loops ---
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();

            if (state.upgrades.autoMineLevel > 0) {
                autoMineTimer -= delta;
                if (autoMineTimer <= 0) {
                    autoMineTimer = 1 / (1.3 * state.upgrades.autoMineLevel);
                    const maxIndex = MINE_ROWS * MINE_COLS;
                    let attempts = 0;
                    while(attempts < maxIndex) {
                        const x = autoMineTargetIndex % MINE_COLS, z = Math.floor(autoMineTargetIndex / MINE_COLS);
                        autoMineTargetIndex = (autoMineTargetIndex + 1) % maxIndex;
                        if (mineMeshes[0][z * MINE_COLS + x]) { digBlock(x, 0, z, state.upgrades.clickPower, true, false); break; }
                        attempts++;
                    }
                }
            }
            if (state.agents.tung.cooldown > 0) {
                state.agents.tung.cooldown -= delta;
                if (state.agents.tung.owned && activePanel === 'template-upgrades') updateUI({ fullRender: false });
            }
            visualMiners.forEach(miner => {
                const minerState = miner.state;
                if (minerState === 'IDLE') {
                    const availableBlocks = mineMeshes[0].filter(Boolean);
                    if (availableBlocks.length > 0) { miner.target = availableBlocks[Math.floor(Math.random() * availableBlocks.length)]; miner.state = 'MOVING'; }
                } else if (minerState === 'MOVING') {
                    if (!miner.target || !scene.children.includes(miner.target)) { miner.state = 'IDLE'; return; }
                    const targetPos = new THREE.Vector3(miner.target.position.x, 0.5, miner.target.position.z);
                    miner.mesh.position.lerp(targetPos, delta * (3 + state.upgrades.minerStaminaLevel * 0.5));
                    if (miner.mesh.position.distanceTo(targetPos) < 0.1) { miner.state = 'DIGGING'; miner.digTimer = 1 / (1.3 + state.upgrades.minerStaminaLevel * 0.3); }
                } else if (minerState === 'DIGGING') {
                    if (!miner.target || !scene.children.includes(miner.target)) { miner.state = 'IDLE'; return; }
                    miner.digTimer -= delta;
                    miner.mesh.position.y = 0.5 + Math.sin(clock.getElapsedTime() * 20) * 0.1;
                    if (miner.digTimer <= 0) {
                        const { gridX, gridY, gridZ } = miner.target.userData;
                        digBlock(gridX, gridY, gridZ, state.upgrades.minerPowerLevel, false, state.upgrades.superMinerLevel > 0);
                        miner.digTimer = 1 / (1.3 + state.upgrades.minerStaminaLevel * 0.3);
                        if (Math.random() < 1 / Math.max(1, 5 - state.upgrades.minerStaminaLevel * 0.5)) { miner.state = 'RESTING'; miner.restTimer = Math.max(0.5, 3 - state.upgrades.minerStaminaLevel * 0.5); }
                    }
                } else if (minerState === 'RESTING') {
                    miner.restTimer -= delta; miner.mesh.position.y = 0.5;
                    if (miner.restTimer <= 0) miner.state = 'IDLE';
                }
            });
            for (let i = shrinkingBlocks.length - 1; i >= 0; i--) {
                const block = shrinkingBlocks[i]; block.scale.multiplyScalar(0.9);
                if (block.scale.x < 0.01) { scene.remove(block); shrinkingBlocks.splice(i, 1); }
            }
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i]; p.position.addScaledVector(p.velocity, delta); p.lifetime -= delta;
                if (p.lifetime <= 0) { scene.remove(p); particles.splice(i, 1); }
            }
            scene.children.forEach(child => {
                if (child.isMesh && child.userData.gridX !== undefined) {
                    if (child.userData.targetYScale !== undefined && child.scale.y !== child.userData.targetYScale) {
                        child.scale.y = THREE.MathUtils.lerp(child.scale.y, child.userData.targetYScale, delta * 15);
                        child.position.y = -child.userData.gridY * BLOCK_SIZE - (BLOCK_SIZE * (1 - child.scale.y)) / 2;
                    }
                    if (child.userData.targetYPosition !== undefined && Math.abs(child.position.y - child.userData.targetYPosition) > 0.01) {
                        child.position.y = THREE.MathUtils.lerp(child.position.y, child.userData.targetYPosition, delta * 8);
                    } else if (child.userData.targetYPosition !== undefined) child.position.y = child.userData.targetYPosition;
                    if(child.userData.isFlashing) {
                        child.userData.flashTime -= delta;
                        if(child.userData.flashTime <= 0) {
                            if (child.material.emissive) child.material.emissive.setHex(0x000000);
                            child.userData.isFlashing = false;
                        }
                    }
                }
            });
            renderer.render(scene, camera);
        }

        function setupModalListeners() {
            const gachaModal = document.getElementById('gacha-modal');
            gachaModal.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const targetId = button.id;
                if (targetId === 'gacha-close') { 
                    if (!isGachaAnimating) {
                       gachaModal.classList.remove('show');
                    }
                } 
                else if (targetId.startsWith('gacha-again-')) {
                    if (isGachaAnimating) return;
                    const count = parseInt(targetId.split('-')[2]);
                    const bannerId = state.activeBanner;
                    const banner = GACHA_BANNERS[bannerId];
                    if (!banner) return;
                    if (state.resources.money >= banner.cost * count) summonHero(count, bannerId);
                    else showNotification("Kh√¥ng ƒë·ªß ti·ªÅn!", "error");
                }
            });

            document.getElementById('dungeon-combat-modal').addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                switch (button.id) {
                    case 'dungeon-attack-btn': handleDungeonAttack(); break;
                    case 'dungeon-leave-btn': dungeonLose('R·ªùi ƒëi'); break;
                    case 'dungeon-continue-btn': goToNextFloor(); break;
                    case 'dungeon-claim-btn': claimDungeonRewards(false); break;
                }
            });
        }

        // --- Initialization ---
        window.onload = function() {
            moneyEl = document.getElementById('money');
            canvas = document.getElementById('game-canvas');
            panelContainer = document.getElementById('panel-container');
            notificationContainer = document.getElementById('notification-container');
            toggleButtons = {
                upgrades: document.getElementById('toggle-upgrades'), stats: document.getElementById('toggle-stats'),
                gacha: document.getElementById('toggle-gacha'), equipment: document.getElementById('toggle-equipment'),
                dungeon: document.getElementById('toggle-dungeon'), music: document.getElementById('toggle-music'),
            };
            initThreeJS();
            initializeMine();
            setupPanelToggle('toggle-upgrades', 'template-upgrades');
            setupPanelToggle('toggle-stats', 'template-stats');
            setupPanelToggle('toggle-gacha', 'template-gacha');
            setupPanelToggle('toggle-equipment', 'template-equipment');
            setupPanelToggle('toggle-dungeon', 'template-dungeon');
            setupPanelToggle('toggle-music', 'template-music');
            setupEventListeners();
            setupModalListeners();
            initMusicPlayer();
            
            // Auto-play music on first user interaction
            const startMusicOnInteraction = () => {
                if (!state.music.isPlaying) {
                    playTrack();
                }
                document.removeEventListener('click', startMusicOnInteraction);
                document.removeEventListener('keydown', startMusicOnInteraction);
            };
            document.addEventListener('click', startMusicOnInteraction);
            document.addEventListener('keydown', startMusicOnInteraction);
            
            updateUI({ fullRender: true });
            updateEquipmentPopup(); // Initial update
            onWindowResize();
            animate();
            setInterval(() => {
                state.stats.timePlayed++;
                if(activePanel === 'template-stats') renderStatsPanel();
                if(activePanel === 'template-music') renderMusicPanel();
                if(activePanel === 'template-equipment') renderEquipmentPanel();
                updateEquipmentPopup();
            }, 1000);
        }
    </script>
</body>
</html>
